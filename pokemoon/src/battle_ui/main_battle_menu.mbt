// Copyright 2025 International Digital Economy Academy
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

///|
// ä¸»æˆ˜æ–—èœå•é€‰é¡¹
enum MainMenuOption {
  Fight
  Bag
  Pokemon
  Run
}

///|
// ä¸»æˆ˜æ–—èœå•çŠ¶æ€
struct MainBattleMenu {
  mut is_visible: Bool
  mut selected_option: MainMenuOption
  mut entities: Array[@system.Entity]
  mut background_entity: Option[@system.Entity]
  mut title_entity: Option[@system.Entity]
  
  // èœå•ä½ç½®å’Œå°ºå¯¸
  position: @math.Vec2D
  size: @math.Vec2D
  
  // æŒ‰é’®ç›¸å…³
  mut button_entities: Map[MainMenuOption, @system.Entity]
  mut button_text_entities: Map[MainMenuOption, @system.Entity]
}

///|
// å…¨å±€ä¸»æˆ˜æ–—èœå•å®žä¾‹
let main_battle_menu: MainBattleMenu = {
  is_visible: false,
  selected_option: MainMenuOption::Fight,
  entities: Array::new(),
  background_entity: None,
  title_entity: None,
  position: @math.Vec2D(400.0, 300.0),
  size: @math.Vec2D(400.0, 300.0),
  button_entities: Map::new(),
  button_text_entities: Map::new(),
}

///|
// æ¸…ç†èœå•å®žä½“
fn cleanup_menu_entities() -> Unit {
  for entity in main_battle_menu.entities {
    @system.Entity::destroy(entity)
  }
  main_battle_menu.entities.clear()
  main_battle_menu.button_entities.clear()
  main_battle_menu.button_text_entities.clear()
  main_battle_menu.background_entity = None
  main_battle_menu.title_entity = None
}

///|
// æ˜¾ç¤ºä¸»æˆ˜æ–—èœå•
fn show_main_battle_menu() -> Unit {
  if main_battle_menu.is_visible {
    return
  }
  
  main_battle_menu.is_visible = true
  
  // åˆ›å»ºèƒŒæ™¯
  let background = @system.Entity::new()
  @position.positions.set(background, main_battle_menu.position)
  
  let background_sprite = @sprite.Sprite::new_picture(
    @sprite.Picture::new(
      "assets/ui/battle_menu_bg.png",
      size=main_battle_menu.size
    )
  )
  
  @sprite.sprites.set(background, background_sprite)
  @ui.uis.set(background, @ui.Ui::new())
  
  main_battle_menu.background_entity = Some(background)
  main_battle_menu.entities.push(background)
  
  // åˆ›å»ºæ ‡é¢˜
  let title = @system.Entity::new()
  let title_pos = @math.Vec2D(
    main_battle_menu.position.x,
    main_battle_menu.position.y - 120.0
  )
  @position.positions.set(title, title_pos)
  
  let title_text = @sprite.Sprite::new_text(
    @sprite.Text::new("Battle Menu", color="#FFFFFF", font="18px Arial"),
    size=@math.Vec2D(200.0, 30.0)
  )
  
  @sprite.sprites.set(title, title_text)
  @ui.uis.set(title, @ui.Ui::new())
  
  main_battle_menu.title_entity = Some(title)
  main_battle_menu.entities.push(title)
  
  // åˆ›å»ºæˆ˜æ–—æŒ‰é’®
  let fight_button = @system.Entity::new()
  let button_pos = @math.Vec2D(
    main_battle_menu.position.x - 150.0,
    main_battle_menu.position.y - 50.0
  )
  @position.positions.set(fight_button, button_pos)
  
  let fight_sprite = @sprite.Sprite::new_picture(
    @sprite.Picture::new(
      "assets/ui/button_bg.png",
      size=@math.Vec2D(80.0, 25.0)
    )
  )
  
  @sprite.sprites.set(fight_button, fight_sprite)
  @ui.uis.set(fight_button, @ui.Ui::new())
  
  // æ·»åŠ ç¢°æ’žæ£€æµ‹
  let fight_area = @collision.Area::new(
    @collision.CollisionShape::Rect(
      size=@math.Vec2D(80.0, 25.0),
      offset=@math.Vec2D::zero(),
    ),
    @collision.CollisionLayer::new(),
    @collision.CollisionMask::empty(),
  )
  
  fight_area.on_just_released(fn(mouse_button) {
    if mouse_button == @system.MouseButton::Left {
      main_battle_menu.selected_option = MainMenuOption::Fight
      println("âš”ï¸ é€‰æ‹©æˆ˜æ–—")
    }
  })
  
  @collision.areas.set(fight_button, fight_area)
  main_battle_menu.button_entities.set(MainMenuOption::Fight, fight_button)
  main_battle_menu.entities.push(fight_button)
  
  // åˆ›å»ºèƒŒåŒ…æŒ‰é’®
  let bag_button = @system.Entity::new()
  let button_pos = @math.Vec2D(
    main_battle_menu.position.x - 50.0,
    main_battle_menu.position.y - 50.0
  )
  @position.positions.set(bag_button, button_pos)
  
  let bag_sprite = @sprite.Sprite::new_picture(
    @sprite.Picture::new(
      "assets/ui/button_bg.png",
      size=@math.Vec2D(80.0, 25.0)
    )
  )
  
  @sprite.sprites.set(bag_button, bag_sprite)
  @ui.uis.set(bag_button, @ui.Ui::new())
  
  let bag_area = @collision.Area::new(
    @collision.CollisionShape::Rect(
      size=@math.Vec2D(80.0, 25.0),
      offset=@math.Vec2D::zero(),
    ),
    @collision.CollisionLayer::new(),
    @collision.CollisionMask::empty(),
  )
  
  bag_area.on_just_released(fn(mouse_button) {
    if mouse_button == @system.MouseButton::Left {
      main_battle_menu.selected_option = MainMenuOption::Bag
      println("ðŸŽ’ é€‰æ‹©èƒŒåŒ…")
    }
  })
  
  @collision.areas.set(bag_button, bag_area)
  main_battle_menu.button_entities.set(MainMenuOption::Bag, bag_button)
  main_battle_menu.entities.push(bag_button)
  
  // åˆ›å»ºå®å¯æ¢¦æŒ‰é’®
  let pokemon_button = @system.Entity::new()
  let button_pos = @math.Vec2D(
    main_battle_menu.position.x + 50.0,
    main_battle_menu.position.y - 50.0
  )
  @position.positions.set(pokemon_button, button_pos)
  
  let pokemon_sprite = @sprite.Sprite::new_picture(
    @sprite.Picture::new(
      "assets/ui/button_bg.png",
      size=@math.Vec2D(80.0, 25.0)
    )
  )
  
  @sprite.sprites.set(pokemon_button, pokemon_sprite)
  @ui.uis.set(pokemon_button, @ui.Ui::new())
  
  let pokemon_area = @collision.Area::new(
    @collision.CollisionShape::Rect(
      size=@math.Vec2D(80.0, 25.0),
      offset=@math.Vec2D::zero(),
    ),
    @collision.CollisionLayer::new(),
    @collision.CollisionMask::empty(),
  )
  
  pokemon_area.on_just_released(fn(mouse_button) {
    if mouse_button == @system.MouseButton::Left {
      main_battle_menu.selected_option = MainMenuOption::Pokemon
      println("ðŸ”® é€‰æ‹©å®å¯æ¢¦")
    }
  })
  
  @collision.areas.set(pokemon_button, pokemon_area)
  main_battle_menu.button_entities.set(MainMenuOption::Pokemon, pokemon_button)
  main_battle_menu.entities.push(pokemon_button)
  
  // åˆ›å»ºé€ƒè·‘æŒ‰é’®
  let run_button = @system.Entity::new()
  let button_pos = @math.Vec2D(
    main_battle_menu.position.x + 150.0,
    main_battle_menu.position.y - 50.0
  )
  @position.positions.set(run_button, button_pos)
  
  let run_sprite = @sprite.Sprite::new_picture(
    @sprite.Picture::new(
      "assets/ui/button_bg.png",
      size=@math.Vec2D(80.0, 25.0)
    )
  )
  
  @sprite.sprites.set(run_button, run_sprite)
  @ui.uis.set(run_button, @ui.Ui::new())
  
  let run_area = @collision.Area::new(
    @collision.CollisionShape::Rect(
      size=@math.Vec2D(80.0, 25.0),
      offset=@math.Vec2D::zero(),
    ),
    @collision.CollisionLayer::new(),
    @collision.CollisionMask::empty(),
  )
  
  run_area.on_just_released(fn(mouse_button) {
    if mouse_button == @system.MouseButton::Left {
      main_battle_menu.selected_option = MainMenuOption::Run
      println("ðŸƒ é€‰æ‹©é€ƒè·‘")
    }
  })
  
  @collision.areas.set(run_button, run_area)
  main_battle_menu.button_entities.set(MainMenuOption::Run, run_button)
  main_battle_menu.entities.push(run_button)
  
  // æ·»åŠ æŒ‰é’®æ–‡æœ¬
  add_button_text(MainMenuOption::Fight, "Fight", button_pos.x, button_pos.y)
  add_button_text(MainMenuOption::Bag, "Bag", button_pos.x, button_pos.y)
  add_button_text(MainMenuOption::Pokemon, "Pokemon", button_pos.x, button_pos.y)
  add_button_text(MainMenuOption::Run, "Run", button_pos.x, button_pos.y)
  
  println("ðŸŽ® ä¸»æˆ˜æ–—èœå•å·²æ˜¾ç¤º")
}

///|
// æ·»åŠ æŒ‰é’®æ–‡æœ¬
fn add_button_text(option: MainMenuOption, text: String, x: Float, y: Float) -> Unit {
  let text_entity = @system.Entity::new()
  let text_sprite = @sprite.Sprite::new_text(
    @sprite.Text::new(text, color="#FFFFFF", font="16px Arial"),
    size=@math.Vec2D(80.0, 25.0)
  )
  
  @sprite.sprites.set(text_entity, text_sprite)
  @position.positions.set(text_entity, @math.Vec2D(x + 40, y + 5)) // æ–‡æœ¬å±…ä¸­
  @ui.uis.set(text_entity, @ui.Ui::new())
  
  main_battle_menu.button_text_entities.set(option, text_entity)
  main_battle_menu.entities.push(text_entity)
}

///|
// éšè—ä¸»æˆ˜æ–—èœå•
fn hide_main_battle_menu() -> Unit {
  if !main_battle_menu.is_visible {
    return
  }
  
  main_battle_menu.is_visible = false
  cleanup_menu_entities()
  println("ðŸŽ® ä¸»æˆ˜æ–—èœå•å·²éšè—")
}

///|
// åˆ‡æ¢ä¸»æˆ˜æ–—èœå•æ˜¾ç¤ºçŠ¶æ€
fn toggle_main_battle_menu() -> Unit {
  if main_battle_menu.is_visible {
    hide_main_battle_menu()
  } else {
    show_main_battle_menu()
  }
}

///|
// æ£€æŸ¥ä¸»æˆ˜æ–—èœå•æ˜¯å¦å¯è§
fn is_main_battle_menu_visible() -> Bool {
  main_battle_menu.is_visible
}

///|
// èŽ·å–é€‰ä¸­çš„ä¸»èœå•é€‰é¡¹
fn get_selected_main_menu_option() -> MainMenuOption {
  main_battle_menu.selected_option
} 