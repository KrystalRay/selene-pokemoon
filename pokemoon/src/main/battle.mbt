// Copyright 2025 International Digital Economy Academy
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

///|
// æˆ˜æ–—çŠ¶æ€æšä¸¾
enum BattleState {
  InBattle
  NotInBattle
} derive(Show)

///|
// èœå•é€‰é¡¹æšä¸¾
enum MenuOption {
  Fight
  Bag
  Pokemon
  Run
} derive(Show, Eq, Hash)

///|
// ä¸»æˆ˜æ–—èœå•
struct MainBattleMenu {
  mut visible : Bool
  mut selected_index : Int
  entities : Array[@system.Entity]
  background_entity : Option[@system.Entity]
  title_entity : Option[@system.Entity]
  indicator_entity : Option[@system.Entity]
  
  // å‡ ä½•å±æ€§
  position : @math.Vec2D
  width : Double
  height : Double
  
  // ä¸»æˆ˜æ–—èœå•ç‰¹æœ‰å­—æ®µ
  mut selected_option : MenuOption
  button_entities : Map[MenuOption, @system.Entity]
  button_text_entities : Map[MenuOption, @system.Entity]
}

///|
// æŠ€èƒ½èœå•
struct SkillMenu {
  mut visible : Bool
  mut selected_index : Int
  mut entities : Array[@system.Entity]
  mut background_entity : Option[@system.Entity]
  mut title_entity : Option[@system.Entity]
  mut indicator_entity : Option[@system.Entity]
  
  // å‡ ä½•å±æ€§
  mut position : @math.Vec2D
  width : Double
  height : Double
  
  // æŠ€èƒ½èœå•ç‰¹æœ‰å­—æ®µ
  mut skills : Array[Skill]
  mut skill_entities : Array[@system.Entity]
}

///|
// æˆ˜æ–—ç³»ç»Ÿç»„ä»¶
struct BattleSystem {
  mut state : BattleState
  mut battle_entities : Array[@system.Entity]
  // ä½¿ç”¨æ–°çš„èœå•ç³»ç»Ÿ
  main_menu : MainBattleMenu
  skill_menu : SkillMenu
  mut enemy_hp : Int
  mut player_hp : Int
  enemy_max_hp : Int
  player_max_hp : Int
  mut enemy_hp_entity : Option[@system.Entity]
  mut player_hp_entity : Option[@system.Entity]
  // è°ƒè¯•ç›¸å…³
  mut debug_entities : Array[@system.Entity]
}

///|
// å…¨å±€æˆ˜æ–—ç³»ç»Ÿå®ä¾‹
let battle_system : BattleSystem = {
  state: NotInBattle,
  battle_entities: Array::new(),
  main_menu: MainBattleMenu::{
    visible: false,
    selected_index: 0,
    entities: Array::new(),
    background_entity: None,
    title_entity: None,
    indicator_entity: None,
    position: @math.Vec2D(50.0, 400.0),
    width: 170.0,
    height: 115.0,
    selected_option: Fight,
    button_entities: Map::new(),
    button_text_entities: Map::new()
  },
  skill_menu: SkillMenu::{
    visible: false,
    selected_index: 0,
    entities: Array::new(),
    background_entity: None,
    title_entity: None,
    indicator_entity: None,
    position: @math.Vec2D(250.0, 400.0),
    width: 220.0,
    height: 200.0,
    skills: Array::new(),
    skill_entities: Array::new()
  },
  enemy_hp: 100,
  player_hp: 100,
  enemy_max_hp: 100,
  player_max_hp: 100,
  enemy_hp_entity: None,
  player_hp_entity: None,
  debug_entities: Array::new()
}

///|
// æŠ€èƒ½æ•°æ®ç»“æ„
struct Skill {
  name : String
  damage : Int
  description : String
  mp_cost : Int
}

///|
// åˆå§‹åŒ–æŠ€èƒ½æ•°æ®
fn init_skills() -> Unit {
  let skills = Array::new()
  skills.push(Skill::{ name: "Tackle", damage: 15, description: "A basic attack", mp_cost: 0 })
  skills.push(Skill::{ name: "Ember", damage: 25, description: "A fire attack", mp_cost: 5 })
  skills.push(Skill::{ name: "Thunder", damage: 35, description: "An electric attack", mp_cost: 10 })
  skills.push(Skill::{ name: "Hyper Beam", damage: 50, description: "A powerful beam", mp_cost: 20 })
  
  battle_system.skill_menu.skills = skills
}

///|
// è¿›å…¥æˆ˜æ–—çŠ¶æ€
fn enter_battle() -> Unit {
  battle_system.state = InBattle
  battle_system.main_menu.selected_option = Fight
  // é‡ç½®HP
  battle_system.enemy_hp = 100
  battle_system.player_hp = 100
  
  // ä½¿ç”¨å‡ ä½•å±æ€§è°ƒæ•´èœå•å°ºå¯¸å’Œä½ç½®
  adjust_menu_sizes()
  reposition_menus()
  
  // åˆ›å»ºæˆ˜æ–—ç•Œé¢å®ä½“
  create_battle_entities()
  // åˆ›å»ºèœå•è°ƒè¯•è¾¹ç•Œæ¡†
  create_menu_debug_boundaries()
  // æ˜¾ç¤ºèœå•å‡ ä½•ä¿¡æ¯
  show_menu_geometry_info()
  // è°ƒè¯•å¸ƒå±€ä¿¡æ¯
  debug_battle_layout()
}

///|
// é€€å‡ºæˆ˜æ–—çŠ¶æ€
fn exit_battle() -> Unit {
  battle_system.state = NotInBattle
  // æ¸…ç†æˆ˜æ–—ç•Œé¢å®ä½“
  cleanup_battle_entities()
}

///|
// åŸºç¡€èœå•ç®¡ç†å‡½æ•° - å±•ç¤ºç»Ÿä¸€èœå•ç³»ç»Ÿçš„ä¼˜åŠ¿

// æ­¤å‡½æ•°å·²è¢«ç§»é™¤

// æ­¤å‡½æ•°å·²è¢«ç§»é™¤

// æ­¤å‡½æ•°å·²è¢«ç§»é™¤

// æ­¤å‡½æ•°å·²è¢«ç§»é™¤

// æ­¤å‡½æ•°å·²è¢«ç§»é™¤

///|
// æ£€æŸ¥æ˜¯å¦åœ¨æˆ˜æ–—çŠ¶æ€
fn is_in_battle() -> Bool {
  match battle_system.state {
    InBattle => true
    NotInBattle => false
  }
}

///|
// è·å–èœå•é€‰é¡¹çš„æ˜¾ç¤ºæ–‡æœ¬
fn get_menu_option_text(option : MenuOption) -> String {
  match option {
    Fight => "Fight"
    Bag => "Bag"
    Pokemon => "Pokemon"
    Run => "Run"
  }
}

///|
// è·å–ä¸‹ä¸€ä¸ªèœå•é€‰é¡¹
fn get_next_menu_option(current : MenuOption) -> MenuOption {
  match current {
    Fight => Bag
    Bag => Pokemon
    Pokemon => Run
    Run => Fight
  }
}

///|
// è·å–ä¸Šä¸€ä¸ªèœå•é€‰é¡¹
fn get_prev_menu_option(current : MenuOption) -> MenuOption {
  match current {
    Fight => Run
    Bag => Fight
    Pokemon => Bag
    Run => Pokemon
  }
}



///|
// åˆ›å»ºæˆ˜æ–—ç•Œé¢å®ä½“
fn create_battle_entities() -> Unit {
  // ä½¿ç”¨ç°æœ‰çš„å¸ƒå±€ç³»ç»Ÿ
  let enemy_pos = get_enemy_area_position()
  let player_pos = get_player_area_position()
  let title_pos = get_title_position()
  
  // åˆ›å»ºæˆ˜æ–—èƒŒæ™¯sprite - è¦†ç›–æ•´ä¸ªå±å¹•
  let background_entity = @system.Entity::new()
  let background_sprite = @sprite.Sprite::new_picture(
    @sprite.Picture::new(
      @math.Vec2D(VIEWPORT_WIDTH, VIEWPORT_HEIGHT),
      "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTEyIiBoZWlnaHQ9IjM4NCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjM4NCIgZmlsbD0iIzAwMDAwMCIvPjwvc3ZnPg=="
    ),
    150
  )
  @sprite.sprites.set(background_entity, background_sprite)
  @position.positions.set(background_entity, @math.Vec2D(0.0, 0.0))
  @ui.uis.set(background_entity, @ui.Ui::new())
  battle_system.battle_entities.push(background_entity)
  
  // åˆ›å»ºæˆ˜æ–—æ ‡é¢˜sprite - å±å¹•é¡¶éƒ¨ä¸­å¤®
  let title_entity = @system.Entity::new()
  let title_sprite = @sprite.Sprite::new_text(@sprite.Text::new("BATTLE!", font="bold 32px Arial"), 250)
  @sprite.sprites.set(title_entity, title_sprite)
  @position.positions.set(title_entity, title_pos)
  @ui.uis.set(title_entity, @ui.Ui::new())
  battle_system.battle_entities.push(title_entity)
  
  // åˆ›å»ºæˆ˜æ–—æç¤ºsprite - æ ‡é¢˜ä¸‹æ–¹
  let prompt_entity = @system.Entity::new()
  let prompt_sprite = @sprite.Sprite::new_text(@sprite.Text::new("Use â†‘â†“ to select, Z to confirm", font="18px Arial"), 250)
  @sprite.sprites.set(prompt_entity, prompt_sprite)
  @position.positions.set(prompt_entity, @math.Vec2D(title_pos.0, title_pos.1 + 40.0))
  @ui.uis.set(prompt_entity, @ui.Ui::new())
  battle_system.battle_entities.push(prompt_entity)
  
  // åˆ›å»ºEnemyåŒºåŸŸ - åŸºäºå¸ƒå±€ç³»ç»Ÿ
  create_enemy_entities_simple(enemy_pos)
  
  // åˆ›å»ºPlayeråŒºåŸŸ - åŸºäºå¸ƒå±€ç³»ç»Ÿ
  create_player_entities_simple(player_pos)
  
  // åˆ›å»ºæˆ˜æ–—èœå•æŒ‰é’® - ä½¿ç”¨ç®€åŒ–çš„è®¾ç½®
  setup_battle_menu()
  
  // åˆ›å»ºçŠ¶æ€ä¿¡æ¯sprite - åŸºäºPlayeråŒºåŸŸä½ç½®
  let mp_entity = @system.Entity::new()
  let mp_sprite = @sprite.Sprite::new_text(@sprite.Text::new("MP: 50/50", font="16px Arial"), 250)
  @sprite.sprites.set(mp_entity, mp_sprite)
  @position.positions.set(mp_entity, @math.Vec2D(player_pos.0, player_pos.1 + battle_layout.player_area_height + 20.0))
  @ui.uis.set(mp_entity, @ui.Ui::new())
  battle_system.battle_entities.push(mp_entity)
  
  let level_entity = @system.Entity::new()
  let level_sprite = @sprite.Sprite::new_text(@sprite.Text::new("Level: 5", font="16px Arial"), 250)
  @sprite.sprites.set(level_entity, level_sprite)
  @position.positions.set(level_entity, @math.Vec2D(player_pos.0, player_pos.1 + battle_layout.player_area_height + 40.0))
  @ui.uis.set(level_entity, @ui.Ui::new())
  battle_system.battle_entities.push(level_entity)
}

///|
// åˆ›å»ºEnemyå®ä½“ - åŸºäºå¸ƒå±€ä½ç½®
fn create_enemy_entities_simple(enemy_pos : @math.Vec2D) -> Unit {
  // åˆ›å»ºæ•ŒäººåŒºåŸŸsprite
  let enemy_entity = @system.Entity::new()
  let enemy_sprite = @sprite.Sprite::new_picture(
    @sprite.Picture::new(
      @math.Vec2D(battle_layout.enemy_area_width, battle_layout.enemy_area_height),
      "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iI2ZmNmI2YiIvPjwvc3ZnPg=="
    ),
    250
  )
  @sprite.sprites.set(enemy_entity, enemy_sprite)
  @position.positions.set(enemy_entity, enemy_pos)
  @ui.uis.set(enemy_entity, @ui.Ui::new())
  battle_system.battle_entities.push(enemy_entity)
  
  // åˆ›å»ºæ•Œäººæ ‡ç­¾sprite
  let enemy_label_entity = @system.Entity::new()
  let enemy_label_sprite = @sprite.Sprite::new_text(@sprite.Text::new("Enemy", font="16px Arial"), 250)
  @sprite.sprites.set(enemy_label_entity, enemy_label_sprite)
  @position.positions.set(enemy_label_entity, @math.Vec2D(enemy_pos.0 + battle_layout.enemy_area_width / 2.0, enemy_pos.1 + battle_layout.enemy_area_height - 30.0))
  @ui.uis.set(enemy_label_entity, @ui.Ui::new())
  battle_system.battle_entities.push(enemy_label_entity)
  
  // åˆ›å»ºæ•ŒäººHPæ˜¾ç¤ºsprite
  let enemy_hp_entity = @system.Entity::new()
  let enemy_hp_text = "HP: " + battle_system.enemy_hp.to_string() + "/" + battle_system.enemy_max_hp.to_string()
  let enemy_hp_sprite = @sprite.Sprite::new_text(@sprite.Text::new(enemy_hp_text, font="16px Arial"), 250)
  @sprite.sprites.set(enemy_hp_entity, enemy_hp_sprite)
  @position.positions.set(enemy_hp_entity, @math.Vec2D(enemy_pos.0 + battle_layout.enemy_area_width / 2.0, enemy_pos.1 + battle_layout.enemy_area_height - 10.0))
  @ui.uis.set(enemy_hp_entity, @ui.Ui::new())
  battle_system.enemy_hp_entity = Some(enemy_hp_entity)
  battle_system.battle_entities.push(enemy_hp_entity)
}

///|
// åˆ›å»ºPlayerå®ä½“ - åŸºäºå¸ƒå±€ä½ç½®
fn create_player_entities_simple(player_pos : @math.Vec2D) -> Unit {
  // åˆ›å»ºç©å®¶åŒºåŸŸsprite
  let player_entity = @system.Entity::new()
  let player_sprite = @sprite.Sprite::new_picture(
    @sprite.Picture::new(
      @math.Vec2D(battle_layout.player_area_width, battle_layout.player_area_height),
      "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTEyIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjEwMCIgZmlsbD0iIzRlY2RjNCIvPjwvc3ZnPg=="
    ),
    250
  )
  @sprite.sprites.set(player_entity, player_sprite)
  @position.positions.set(player_entity, player_pos)
  @ui.uis.set(player_entity, @ui.Ui::new())
  battle_system.battle_entities.push(player_entity)
  
  // åˆ›å»ºç©å®¶æ ‡ç­¾sprite
  let player_label_entity = @system.Entity::new()
  let player_label_sprite = @sprite.Sprite::new_text(@sprite.Text::new("Player", font="16px Arial"), 250)
  @sprite.sprites.set(player_label_entity, player_label_sprite)
  @position.positions.set(player_label_entity, @math.Vec2D(player_pos.0 + battle_layout.player_area_width / 2.0, player_pos.1 + battle_layout.player_area_height - 30.0))
  @ui.uis.set(player_label_entity, @ui.Ui::new())
  battle_system.battle_entities.push(player_label_entity)
  
  // åˆ›å»ºç©å®¶HPæ˜¾ç¤ºsprite
  let player_hp_entity = @system.Entity::new()
  let player_hp_text = "HP: " + battle_system.player_hp.to_string() + "/" + battle_system.player_max_hp.to_string()
  let player_hp_sprite = @sprite.Sprite::new_text(@sprite.Text::new(player_hp_text, font="16px Arial"), 250)
  @sprite.sprites.set(player_hp_entity, player_hp_sprite)
  @position.positions.set(player_hp_entity, @math.Vec2D(player_pos.0 + battle_layout.player_area_width / 2.0, player_pos.1 + battle_layout.player_area_height - 10.0))
  @ui.uis.set(player_hp_entity, @ui.Ui::new())
  battle_system.player_hp_entity = Some(player_hp_entity)
  battle_system.battle_entities.push(player_hp_entity)
}







///|
// æ›´æ–°èœå•é€‰æ‹©æ˜¾ç¤º
fn update_menu_selection() -> Unit {
  // æŒ‰é’®è§†è§‰æ•ˆæœæ›´æ–°å·²ç§»é™¤ï¼ˆä¸å†ä½¿ç”¨æŒ‰é’®å®ä½“ï¼‰
  // ç°åœ¨åªæ›´æ–°æ–‡æœ¬æ˜¾ç¤º
}



///|
// è®¡ç®—æŠ€èƒ½èœå•çš„æœ€ä½³ä½ç½®
fn calculate_skill_menu_position() -> @math.Vec2D {
  // åŸºäºå±å¹•å°ºå¯¸å’Œç°æœ‰UIå…ƒç´ è®¡ç®—æœ€ä½³ä½ç½®
  let screen_width = 800.0
  // screen_height å˜é‡å·²è¢«ç§»é™¤ï¼Œä¸å†ä½¿ç”¨
  
  // ä½¿ç”¨æŠ€èƒ½èœå•çš„å†…ç½®å°ºå¯¸
  let menu_width = battle_system.skill_menu.width
  let menu_height = battle_system.skill_menu.height
  
  // ä¸»èœå•æŒ‰é’®åŒºåŸŸï¼ˆå·¦ä¸‹è§’ï¼‰
  let main_menu_left = battle_system.main_menu.position.0
  let main_menu_right = main_menu_left + battle_system.main_menu.width
  let main_menu_top = battle_system.main_menu.position.1
  let main_menu_bottom = main_menu_top + battle_system.main_menu.height
  
  // è¿™äº›ç¡¬ç¼–ç çš„åæ ‡å€¼å·²è¢«ç§»é™¤ï¼Œç°åœ¨ä½¿ç”¨é…ç½®ç³»ç»Ÿ
  
  // å°è¯•å¤šä¸ªä½ç½®ï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åº
  let possible_positions = [
    // ä½ç½®1ï¼šä¸»èœå•å³ä¾§ï¼Œç´§è´´ä¸»èœå•
    @math.Vec2D(main_menu_right + 10.0, main_menu_top),
    // ä½ç½®2ï¼šä¸»èœå•å³ä¾§ï¼Œç¨å¾®ä¸Šç§»
    @math.Vec2D(main_menu_right + 10.0, main_menu_top - 20.0),
    // ä½ç½®3ï¼šå±å¹•å³ä¾§ï¼Œé¿å…ä¸ç©å®¶çŠ¶æ€é‡å 
    @math.Vec2D(screen_width - menu_width - 20.0, main_menu_top),
    // ä½ç½®4ï¼šå±å¹•ä¸­å¤®ä¸‹æ–¹
    @math.Vec2D((screen_width - menu_width) / 2.0, main_menu_top - 40.0)
  ]
  
  // æ£€æŸ¥æ¯ä¸ªä½ç½®æ˜¯å¦æœ‰å†²çª
  for position in possible_positions {
    if !has_skill_menu_collision(position, @math.Vec2D(menu_width, menu_height)) {
      return position
    }
  }
  
  // å¦‚æœæ‰€æœ‰ä½ç½®éƒ½æœ‰å†²çªï¼Œè¿”å›é»˜è®¤ä½ç½®
  return @math.Vec2D(main_menu_right + 10.0, main_menu_top)
}

///|
// æ£€æŸ¥æŠ€èƒ½èœå•ä½ç½®æ˜¯å¦ä¸å…¶ä»–UIå…ƒç´ å†²çª
fn has_skill_menu_collision(position : @math.Vec2D, size : @math.Vec2D) -> Bool {
  let menu_left = position.0
  let menu_right = position.0 + size.0
  let menu_top = position.1
  let menu_bottom = position.1 + size.1
  
  // æ£€æŸ¥ä¸ä¸»èœå•æŒ‰é’®åŒºåŸŸçš„å†²çª - ä½¿ç”¨battle_systemä¸­çš„å‡ ä½•å±æ€§
  let main_menu_left = battle_system.main_menu.position.0
  let main_menu_right = main_menu_left + battle_system.main_menu.width
  let main_menu_top = battle_system.main_menu.position.1
  let main_menu_bottom = main_menu_top + battle_system.main_menu.height
  
  if menu_left < main_menu_right && menu_right > main_menu_left &&
     menu_top < main_menu_bottom && menu_bottom > main_menu_top {
    return true
  }
  
  // æ£€æŸ¥ä¸æ•ŒäººåŒºåŸŸçš„å†²çª - ä½¿ç”¨é…ç½®ç³»ç»Ÿ
  let enemy_pos = get_enemy_area_position()
  let enemy_left = enemy_pos.0
  let enemy_right = enemy_pos.0 + 120.0  // ä½¿ç”¨battle_layoutä¸­çš„å°ºå¯¸
  let enemy_top = enemy_pos.1
  let enemy_bottom = enemy_pos.1 + 100.0
  
  if menu_left < enemy_right && menu_right > enemy_left &&
     menu_top < enemy_bottom && menu_bottom > enemy_top {
    return true
  }
  
  // æ£€æŸ¥ä¸ç©å®¶åŒºåŸŸçš„å†²çª - ä½¿ç”¨é…ç½®ç³»ç»Ÿ
  let player_pos = get_player_area_position()
  let player_left = player_pos.0
  let player_right = player_pos.0 + 120.0  // ä½¿ç”¨battle_layoutä¸­çš„å°ºå¯¸
  let player_top = player_pos.1
  let player_bottom = player_pos.1 + 100.0
  
  if menu_left < player_right && menu_right > player_left &&
     menu_top < player_bottom && menu_bottom > player_top {
    return true
  }
  
  // æ£€æŸ¥ä¸çŠ¶æ€ä¿¡æ¯åŒºåŸŸçš„å†²çª - ä½¿ç”¨é…ç½®ç³»ç»Ÿ
  let status_pos = get_status_area_position()
  let status_left = status_pos.0
  let status_right = status_pos.0 + 100.0  // ä½¿ç”¨battle_layoutä¸­çš„å°ºå¯¸
  let status_top = status_pos.1
  let status_bottom = status_pos.1 + 80.0
  
  if menu_left < status_right && menu_right > status_left &&
     menu_top < status_bottom && menu_bottom > status_top {
    return true
  }
  
  return false
}

///|
// åˆ›å»ºæŠ€èƒ½èœå•
fn create_skill_menu() -> Unit {
  // æ¸…ç†ä¹‹å‰çš„æŠ€èƒ½èœå•å®ä½“
  cleanup_skill_menu()
  
  // åˆå§‹åŒ–æŠ€èƒ½æ•°æ®
  init_skills()
  
  // è®¡ç®—èœå•ä½ç½®
  let menu_position = calculate_skill_menu_position()
  println("ğŸ¯ æŠ€èƒ½èœå•ä½ç½®: (" + menu_position.0.to_string() + ", " + menu_position.1.to_string() + ")")
  
  // æ›´æ–°æŠ€èƒ½èœå•çš„å†…ç½®ä½ç½®
  battle_system.skill_menu.position = menu_position
  
  // åˆ›å»ºæŠ€èƒ½èœå•èƒŒæ™¯ - ä½¿ç”¨å†…ç½®å°ºå¯¸
  let background_entity = @system.Entity::new()
  let background_sprite = @sprite.Sprite::new_picture(
    @sprite.Picture::new(
      @math.Vec2D(battle_system.skill_menu.width, battle_system.skill_menu.height),
      "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjIwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjIwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iIzFhMWExYSIgc3Ryb2tlPSIjNGVjZGM0IiBzdHJva2Utd2lkdGg9IjIiIHJ4PSI4Ii8+PC9zdmc+"
    ),
    200
  )
  @sprite.sprites.set(background_entity, background_sprite)
  @position.positions.set(background_entity, menu_position)
  @ui.uis.set(background_entity, @ui.Ui::new())
  
  battle_system.skill_menu.background_entity = Some(background_entity)
  battle_system.skill_menu.entities.push(background_entity)
  
  // åˆ›å»ºæŠ€èƒ½èœå•æ ‡é¢˜
  let title_entity = @system.Entity::new()
  let title_sprite = @sprite.Sprite::new_text(
    @sprite.Text::new("SKILLS", color="#FFFFFF", font="bold 18px Arial"), 
    250
  )
  @sprite.sprites.set(title_entity, title_sprite)
  @position.positions.set(title_entity, @math.Vec2D(menu_position.0 + 20.0, menu_position.1 + 15.0))
  @ui.uis.set(title_entity, @ui.Ui::new())
  
  battle_system.skill_menu.title_entity = Some(title_entity)
  battle_system.skill_menu.entities.push(title_entity)
  
  // åˆ›å»ºæŠ€èƒ½é€‰é¡¹
  let mut skill_y_offset = 50.0
  let mut i = 0
  
  while i < battle_system.skill_menu.skills.length() {
    let skill = battle_system.skill_menu.skills[i]
    let skill_entity = @system.Entity::new()
    
    // æŠ€èƒ½æ–‡æœ¬æ ¼å¼ï¼šåç§° (ä¼¤å®³) - MPæ¶ˆè€—
    let skill_text = skill.name + " (" + skill.damage.to_string() + " DMG) - " + skill.mp_cost.to_string() + " MP"
    let skill_sprite = @sprite.Sprite::new_text(
      @sprite.Text::new(skill_text, color="#FFFFFF", font="14px Arial"), 
      250
    )
    
    @sprite.sprites.set(skill_entity, skill_sprite)
    @position.positions.set(skill_entity, @math.Vec2D(menu_position.0 + 25.0, menu_position.1 + skill_y_offset))
    @ui.uis.set(skill_entity, @ui.Ui::new())
    
    battle_system.skill_menu.skill_entities.push(skill_entity)
    battle_system.skill_menu.entities.push(skill_entity)
    
    skill_y_offset = skill_y_offset + 30.0
    i = i + 1
  }
  
  // åˆ›å»ºé€‰æ‹©æŒ‡ç¤ºå™¨
  let indicator_entity = @system.Entity::new()
  let indicator_sprite = @sprite.Sprite::new_text(
    @sprite.Text::new("â–¶", color="#4ECDC4", font="bold 16px Arial"), 
    250
  )
  @sprite.sprites.set(indicator_entity, indicator_sprite)
  @position.positions.set(indicator_entity, @math.Vec2D(menu_position.0 + 10.0, menu_position.1 + 50.0))
  @ui.uis.set(indicator_entity, @ui.Ui::new())
  
  battle_system.skill_menu.indicator_entity = Some(indicator_entity)
  battle_system.skill_menu.entities.push(indicator_entity)
  

  
  // è®¾ç½®æŠ€èƒ½èœå•ä¸ºå¯è§
  battle_system.skill_menu.visible = true
  battle_system.skill_menu.selected_index = 0
  
  // æ›´æ–°æŠ€èƒ½èœå•çš„å†…ç½®ä½ç½®å’Œå°ºå¯¸ - ä½¿ç”¨å®é™…åˆ›å»ºçš„ä½ç½®
  battle_system.skill_menu.position = menu_position
  // æ³¨æ„ï¼šwidthå’Œheightå·²ç»åœ¨åˆå§‹åŒ–æ—¶è®¾ç½®ï¼Œè¿™é‡Œä¸éœ€è¦æ›´æ–°
  
  // ä¸»èœå•æŒ‰é’®çŠ¶æ€æ›´æ–°å·²ç§»é™¤ï¼ˆä¸å†ä½¿ç”¨æŒ‰é’®å®ä½“ï¼‰
  
  println("âœ… æŠ€èƒ½èœå•å·²åˆ›å»ºï¼ŒåŒ…å« " + battle_system.skill_menu.skills.length().to_string() + " ä¸ªæŠ€èƒ½")
  println("ğŸ“ èœå•ä½ç½®: (" + battle_system.skill_menu.position.0.to_string() + ", " + battle_system.skill_menu.position.1.to_string() + ")")
  println("ğŸ“ èœå•å°ºå¯¸: " + battle_system.skill_menu.width.to_string() + " x " + battle_system.skill_menu.height.to_string())
}

///|
// æ¸…ç†æŠ€èƒ½èœå•å®ä½“
fn cleanup_skill_menu() -> Unit {
  // åˆ é™¤æ‰€æœ‰æŠ€èƒ½èœå•å®ä½“
  for entity in battle_system.skill_menu.entities {
    @system.Entity::destroy(entity)
  }
  
  // é‡ç½®æŠ€èƒ½èœå•çŠ¶æ€
  battle_system.skill_menu.entities = Array::new()
  battle_system.skill_menu.skill_entities = Array::new()
  battle_system.skill_menu.background_entity = None
  battle_system.skill_menu.title_entity = None
  battle_system.skill_menu.indicator_entity = None
  battle_system.skill_menu.visible = false
  battle_system.skill_menu.selected_index = 0
}

///|
// æ›´æ–°HPæ˜¾ç¤º
fn update_hp_display() -> Unit {
  // æ›´æ–°æ•ŒäººHPæ˜¾ç¤º
  match battle_system.enemy_hp_entity {
    Some(enemy_hp_entity) => {
      let enemy_hp_text = "HP: " + battle_system.enemy_hp.to_string() + "/" + battle_system.enemy_max_hp.to_string()
      let enemy_hp_sprite = @sprite.Sprite::new_text(@sprite.Text::new(enemy_hp_text, font="16px Arial"), 250)
      @sprite.sprites.set(enemy_hp_entity, enemy_hp_sprite)
    }
    None => ()
  }
  
  // æ›´æ–°ç©å®¶HPæ˜¾ç¤º
  match battle_system.player_hp_entity {
    Some(player_hp_entity) => {
      let player_hp_text = "HP: " + battle_system.player_hp.to_string() + "/" + battle_system.player_max_hp.to_string()
      let player_hp_sprite = @sprite.Sprite::new_text(@sprite.Text::new(player_hp_text, font="16px Arial"), 250)
      @sprite.sprites.set(player_hp_entity, player_hp_sprite)
    }
    None => ()
  }
}

///|
// å¤„ç†èœå•é€‰æ‹©ç¡®è®¤
fn handle_menu_selection() -> Unit {
  match battle_system.main_menu.selected_option {
    Fight => {
      // æ˜¾ç¤ºæŠ€èƒ½èœå•
      if !battle_system.skill_menu.visible {
        create_skill_menu()
      }
    }
    Bag => {
      // å¤„ç†èƒŒåŒ…é€‰æ‹©
      // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ èƒŒåŒ…é€»è¾‘
      ()
    }
    Pokemon => {
      // å¤„ç†å®å¯æ¢¦é€‰æ‹©
      // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å®å¯æ¢¦ç®¡ç†é€»è¾‘
      ()
    }
    Run => {
      // å¤„ç†é€ƒè·‘é€‰æ‹© - é€€å‡ºæˆ˜æ–—
      exit_battle()
    }
  }
}

///|
// æ›´æ–°æŠ€èƒ½èœå•é€‰æ‹©æŒ‡ç¤ºå™¨
fn update_skill_menu_selection() -> Unit {
  match battle_system.skill_menu.indicator_entity {
    Some(indicator_entity) => {
      // ä½¿ç”¨æŠ€èƒ½èœå•çš„å†…ç½®å‡ ä½•å±æ€§è®¡ç®—æŒ‡ç¤ºå™¨ä½ç½®
      let menu_x = battle_system.skill_menu.position.0
      let menu_y = battle_system.skill_menu.position.1
      
      // è®¡ç®—æŒ‡ç¤ºå™¨çš„æ–°ä½ç½® - åŸºäºèœå•çš„å†…ç½®ä½ç½®å’Œå°ºå¯¸
      let indicator_x = menu_x + 10.0  // è·ç¦»å·¦è¾¹ç•Œ10åƒç´ 
      let indicator_y = menu_y + 50.0 + (battle_system.skill_menu.selected_index.to_double() * 30.0)
      
      @position.positions.set(indicator_entity, @math.Vec2D(indicator_x, indicator_y))
      
      println("ğŸ¯ æŠ€èƒ½é€‰æ‹©æŒ‡ç¤ºå™¨æ›´æ–°: æŠ€èƒ½ " + (battle_system.skill_menu.selected_index + 1).to_string())
      println("ğŸ“ æŒ‡ç¤ºå™¨ä½ç½®: (" + indicator_x.to_string() + ", " + indicator_y.to_string() + ")")
    }
    None => ()
  }
}

///|
// å¤„ç†æŠ€èƒ½é€‰æ‹©
fn handle_skill_selection() -> Unit {
  if battle_system.skill_menu.visible && battle_system.skill_menu.selected_index >= 0 && battle_system.skill_menu.selected_index < battle_system.skill_menu.skills.length() {
    let selected_skill = battle_system.skill_menu.skills[battle_system.skill_menu.selected_index]
    
    println("âš”ï¸ ä½¿ç”¨æŠ€èƒ½: " + selected_skill.name + " (ä¼¤å®³: " + selected_skill.damage.to_string() + ")")
    
    // å¯¹æ•Œäººé€ æˆä¼¤å®³
    if battle_system.enemy_hp > 0 {
      battle_system.enemy_hp = battle_system.enemy_hp - selected_skill.damage
      if battle_system.enemy_hp < 0 {
        battle_system.enemy_hp = 0
      }
      
      // æ›´æ–°HPæ˜¾ç¤º
      update_hp_display()
      println("ğŸ’¥ æ•Œäººå—åˆ° " + selected_skill.damage.to_string() + " ç‚¹ä¼¤å®³ï¼å‰©ä½™HP: " + battle_system.enemy_hp.to_string() + "/" + battle_system.enemy_max_hp.to_string())
      
      // æ£€æŸ¥æ•Œäººæ˜¯å¦è¢«å‡»è´¥
      if battle_system.enemy_hp <= 0 {
        println("ğŸ‰ æ•Œäººè¢«å‡»è´¥äº†ï¼")
        // è¿™é‡Œå¯ä»¥æ·»åŠ èƒœåˆ©é€»è¾‘
      }
    }
    
    // éšè—æŠ€èƒ½èœå•
    cleanup_skill_menu()
    
    // ä¸»èœå•çŠ¶æ€æ¢å¤å·²ç§»é™¤ï¼ˆä¸å†ä½¿ç”¨æŒ‰é’®å®ä½“ï¼‰
  }
}

///|
// è¿”å›ä¸»èœå•
fn return_to_main_menu() -> Unit {
  if battle_system.skill_menu.visible {
    cleanup_skill_menu()
    // ä¸»èœå•çŠ¶æ€æ›´æ–°å·²ç§»é™¤ï¼ˆä¸å†ä½¿ç”¨æŒ‰é’®å®ä½“ï¼‰
    println("ğŸ”™ è¿”å›ä¸»èœå•")
  }
}

///|
// æ¸…ç†æˆ˜æ–—ç•Œé¢å®ä½“
fn cleanup_battle_entities() -> Unit {
  // åˆ é™¤æ‰€æœ‰æˆ˜æ–—å®ä½“
  for entity in battle_system.battle_entities {
    @system.Entity::destroy(entity)
  }
  // æ¸…ç©ºå®ä½“åˆ—è¡¨
  battle_system.battle_entities = Array::new()
  
  // æ¸…ç†è°ƒè¯•å®ä½“
  for entity in battle_system.debug_entities {
    @system.Entity::destroy(entity)
  }
  // æ¸…ç©ºè°ƒè¯•å®ä½“åˆ—è¡¨
  battle_system.debug_entities = Array::new()
}

///|
// æˆ˜æ–—è¾“å…¥ç³»ç»Ÿ
fn battle_input_system(_backend : &@system.Backend) -> Unit {
  if is_in_battle() {
    if battle_system.skill_menu.visible {
      // æŠ€èƒ½èœå•æ¿€æ´»æ—¶çš„è¾“å…¥å¤„ç†
      // ä¸Šä¸‹é”®é€‰æ‹©æŠ€èƒ½
      if @system.is_just_pressed(@system.ArrowUp) {
        if battle_system.skill_menu.selected_index > 0 {
          battle_system.skill_menu.selected_index = battle_system.skill_menu.selected_index - 1
        } else {
          battle_system.skill_menu.selected_index = battle_system.skill_menu.skills.length() - 1
        }
        update_skill_menu_selection()
      }
      
      if @system.is_just_pressed(@system.ArrowDown) {
        if battle_system.skill_menu.selected_index < battle_system.skill_menu.skills.length() - 1 {
          battle_system.skill_menu.selected_index = battle_system.skill_menu.selected_index + 1
        } else {
          battle_system.skill_menu.selected_index = 0
        }
        update_skill_menu_selection()
      }
      
      // Zé”®æˆ–Enteré”®ç¡®è®¤æŠ€èƒ½é€‰æ‹©
      if @system.is_just_pressed(@system.KeyZ) || @system.is_just_pressed(@system.Enter) {
        handle_skill_selection()
      }
      
      // ç©ºæ ¼é”®ä¹Ÿå¯ä»¥ç¡®è®¤æŠ€èƒ½é€‰æ‹©
      if @system.is_just_pressed(@system.Space) {
        handle_skill_selection()
      }
      
      // Xé”®è¿”å›ä¸»èœå•
      if @system.is_just_pressed(@system.KeyX) {
        return_to_main_menu()
      }
      
      // Dé”®æ¿€æ´»è°ƒè¯•æ¨¡å¼
      if @system.is_just_pressed(@system.KeyD) {
        println("ğŸ”§ æŠ€èƒ½èœå•è°ƒè¯•æ¨¡å¼å·²æ¿€æ´»ï¼")
        debug_ui_layout()
        create_debug_boundaries()
      }
      
      // å·¦å³é”®åˆ‡æ¢æŠ€èƒ½é€‰æ‹©
      if @system.is_just_pressed(@system.ArrowLeft) {
        if battle_system.skill_menu.selected_index > 0 {
          battle_system.skill_menu.selected_index = battle_system.skill_menu.selected_index - 1
        } else {
          battle_system.skill_menu.selected_index = battle_system.skill_menu.skills.length() - 1
        }
        update_skill_menu_selection()
      }
      
      if @system.is_just_pressed(@system.ArrowRight) {
        if battle_system.skill_menu.selected_index < battle_system.skill_menu.skills.length() - 1 {
          battle_system.skill_menu.selected_index = battle_system.skill_menu.selected_index + 1
        } else {
          battle_system.skill_menu.selected_index = 0
        }
        update_skill_menu_selection()
      }
    } else {
      // ä¸»èœå•æ¿€æ´»æ—¶çš„è¾“å…¥å¤„ç†
      
      // é¼ æ ‡æ‚¬åœæ£€æµ‹å·²ç§»é™¤ï¼ˆä¸å†ä½¿ç”¨æŒ‰é’®å®ä½“ï¼‰
      
      // ä¸Šä¸‹é”®é€‰æ‹©èœå•é€‰é¡¹
      if @system.is_just_pressed(@system.ArrowUp) {
        battle_system.main_menu.selected_option = get_prev_menu_option(battle_system.main_menu.selected_option)
        update_menu_selection()
      }
      
      if @system.is_just_pressed(@system.ArrowDown) {
        battle_system.main_menu.selected_option = get_next_menu_option(battle_system.main_menu.selected_option)
        update_menu_selection()
      }
      
      // Zé”®æˆ–Enteré”®ç¡®è®¤é€‰æ‹©
      if @system.is_just_pressed(@system.KeyZ) || @system.is_just_pressed(@system.Enter) {
        handle_menu_selection()
      }
      
      // ç©ºæ ¼é”®ä¹Ÿå¯ä»¥ç¡®è®¤é€‰æ‹©
      if @system.is_just_pressed(@system.Space) {
        handle_menu_selection()
      }
      
      // Dé”®æ¿€æ´»è°ƒè¯•æ¨¡å¼
      if @system.is_just_pressed(@system.KeyD) {
        println("ğŸ”§ ä¸»èœå•è°ƒè¯•æ¨¡å¼å·²æ¿€æ´»ï¼")
        debug_ui_layout()
        create_debug_boundaries()
      }
    }
  } else {
    // ä¸åœ¨æˆ˜æ–—ä¸­ï¼ŒæŒ‰Aè¿›å…¥æˆ˜æ–—
    if @system.is_just_pressed(@system.KeyA) {
      enter_battle()
    }
  }
}

///|
// æ£€æµ‹é¼ æ ‡æ‚¬åœåœ¨æŒ‰é’®ä¸Š


///|
// æˆ˜æ–—é¡µé¢æ¸²æŸ“ç³»ç»Ÿ - ç°åœ¨åªæ˜¯çŠ¶æ€æ£€æŸ¥ï¼Œå®ä½“åœ¨çŠ¶æ€å˜åŒ–æ—¶åˆ›å»º/åˆ é™¤
fn battle_render_system(_backend : &@system.Backend) -> Unit {
  // æˆ˜æ–—ç•Œé¢ç°åœ¨é€šè¿‡å®ä½“ç³»ç»Ÿè‡ªåŠ¨æ¸²æŸ“ï¼Œä¸éœ€è¦åœ¨è¿™é‡Œåšä»»ä½•äº‹æƒ…
  // å®ä½“åœ¨è¿›å…¥/é€€å‡ºæˆ˜æ–—æ—¶åˆ›å»º/åˆ é™¤
} 

///|
// è°ƒè¯•UIå¸ƒå±€ä¿¡æ¯
fn debug_ui_layout() -> Unit {
  println("ğŸ”§ === UIå¸ƒå±€è°ƒè¯•ä¿¡æ¯ ===")
  println("å±å¹•å°ºå¯¸: " + VIEWPORT_WIDTH.to_string() + " x " + VIEWPORT_HEIGHT.to_string())
  println("æˆ˜æ–—çŠ¶æ€: " + (if is_in_battle() { "æˆ˜æ–—ä¸­" } else { "éæˆ˜æ–—" }))
  
  // æ˜¾ç¤ºèœå•é€‰é¡¹ä¿¡æ¯
  if is_in_battle() {
    println("å½“å‰é€‰æ‹©: " + get_menu_option_text(battle_system.main_menu.selected_option))
    println("æ‚¬åœé€‰é¡¹: å·²ç§»é™¤ï¼ˆä¸å†ä½¿ç”¨æŒ‰é’®å®ä½“ï¼‰")
  }
  
  // æ˜¾ç¤ºæŠ€èƒ½èœå•ä¿¡æ¯
  if battle_system.skill_menu.visible {
    println("æŠ€èƒ½èœå•: å¯è§")
    println("é€‰ä¸­æŠ€èƒ½ç´¢å¼•: " + battle_system.skill_menu.selected_index.to_string())
    println("æŠ€èƒ½æ•°é‡: " + battle_system.skill_menu.skills.length().to_string())
  } else {
    println("æŠ€èƒ½èœå•: éšè—")
  }
  
  println("ğŸ”§ === è°ƒè¯•ä¿¡æ¯ç»“æŸ ===")
}

///|
// åˆ›å»ºè°ƒè¯•è¾¹ç•Œæ¡†
fn create_debug_boundaries() -> Unit {
  println("ğŸ”§ åˆ›å»ºè°ƒè¯•è¾¹ç•Œæ¡†...")
  
  // åˆ›å»ºä¸»èœå•æŒ‰é’®çš„è¾¹ç•Œæ¡†
  let options = [Fight, Bag, Pokemon, Run]
  for option in options {
    guard battle_system.main_menu.button_entities.get(option) is Some(entity)
    
    // åˆ›å»ºè¾¹ç•Œæ¡†å®ä½“
    let boundary_entity = @system.Entity::new()
    let boundary_sprite = @sprite.Sprite::new_picture(
      @sprite.Picture::new(
        @math.Vec2D(82.0, 27.0), // æ¯”æŒ‰é’®ç¨å¤§ä¸€ç‚¹
        "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODIiIGhlaWdodD0iMjciIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjgyIiBoZWlnaHQ9IjI3IiBmaWxsPSJub25lIiBzdHJva2U9IiNmZjAwMDAiIHN0cm9rZS13aWR0aD0iMiIvPjwvc3ZnPg=="
      ),
      300 // é«˜ä¼˜å…ˆçº§ï¼Œç¡®ä¿åœ¨æœ€ä¸Šå±‚
    )
    @sprite.sprites.set(boundary_entity, boundary_sprite)
    
    // è®¾ç½®è¾¹ç•Œæ¡†ä½ç½®ï¼ˆä¸æŒ‰é’®ä½ç½®ç›¸åŒï¼‰
    guard @position.positions.get(entity) is Some(button_pos)
    @position.positions.set(boundary_entity, button_pos)
    
    // æ·»åŠ åˆ°è°ƒè¯•å®ä½“åˆ—è¡¨
    battle_system.debug_entities.push(boundary_entity)
    
    println("ğŸ”§ ä¸º " + get_menu_option_text(option) + " åˆ›å»ºè¾¹ç•Œæ¡†")
  }
  
  println("ğŸ”§ è°ƒè¯•è¾¹ç•Œæ¡†åˆ›å»ºå®Œæˆ")
} 

///|
// æ˜¾ç¤ºèœå•å‡ ä½•ä¿¡æ¯ - æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨æ–°çš„å‡ ä½•å±æ€§
fn show_menu_geometry_info() -> Unit {
  println("ğŸ“Š èœå•å‡ ä½•ä¿¡æ¯:")
  println("  å±å¹•å°ºå¯¸: 800 x 600")
  println("  ä¸»æˆ˜æ–—èœå•:")
  println("    ä½ç½®: (" + battle_system.main_menu.position.0.to_string() + ", " + battle_system.main_menu.position.1.to_string() + ")")
  println("    å°ºå¯¸: " + battle_system.main_menu.width.to_string() + " x " + battle_system.main_menu.height.to_string())
  println("    å³è¾¹ç•Œ: " + (battle_system.main_menu.position.0 + battle_system.main_menu.width).to_string())
  println("    ä¸‹è¾¹ç•Œ: " + (battle_system.main_menu.position.1 + battle_system.main_menu.height).to_string())
  
  if battle_system.skill_menu.visible {
    println("  æŠ€èƒ½èœå•:")
    println("    ä½ç½®: (" + battle_system.skill_menu.position.0.to_string() + ", " + battle_system.skill_menu.position.1.to_string() + ")")
    println("    å°ºå¯¸: " + battle_system.skill_menu.width.to_string() + " x " + battle_system.skill_menu.height.to_string())
    println("    å³è¾¹ç•Œ: " + (battle_system.skill_menu.position.0 + battle_system.skill_menu.width).to_string())
    println("    ä¸‹è¾¹ç•Œ: " + (battle_system.skill_menu.position.1 + battle_system.skill_menu.height).to_string())
  } else {
    println("  æŠ€èƒ½èœå•: æœªæ˜¾ç¤º")
  }
  
  // éªŒè¯èœå•è¾¹ç•Œ - ä½¿ç”¨æ–°çš„é…ç½®æ¨¡å—
  let _ = validate_menu_boundaries()
} 

// æ­¤å‡½æ•°å·²ç§»åŠ¨åˆ° battle_menu_config.mbt ä¸­ 

// æ­¤å‡½æ•°å·²ç§»åŠ¨åˆ° battle_menu_config.mbt ä¸­ 

// æ­¤å‡½æ•°å·²ç§»åŠ¨åˆ° battle_menu_config.mbt ä¸­ 

///|
// åˆ›å»ºèœå•è°ƒè¯•è¾¹ç•Œæ¡† - æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨å‡ ä½•å±æ€§
fn create_menu_debug_boundaries() -> Unit {
  // ä¸ºä¸»èœå•åˆ›å»ºè¾¹ç•Œæ¡†
  let main_menu_entity = @system.Entity::new()
  let main_menu_boundary = @sprite.Sprite::new_picture(
    @sprite.Picture::new(
      @math.Vec2D(battle_system.main_menu.width, battle_system.main_menu.height),
      "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTcwIiBoZWlnaHQ9IjExNSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTcwIiBoZWlnaHQ9IjExNSIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjZmYwMDAwIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1kYXNoYXJyYXk9IjUsNSIvPjwvc3ZnPg=="
    ),
    100
  )
  @sprite.sprites.set(main_menu_entity, main_menu_boundary)
  @position.positions.set(main_menu_entity, battle_system.main_menu.position)
  @ui.uis.set(main_menu_entity, @ui.Ui::new())
  battle_system.debug_entities.push(main_menu_entity)
  
  // ä¸ºæŠ€èƒ½èœå•åˆ›å»ºè¾¹ç•Œæ¡†ï¼ˆå¦‚æœå¯è§ï¼‰
  if battle_system.skill_menu.visible {
    let skill_menu_entity = @system.Entity::new()
    let skill_menu_boundary = @sprite.Sprite::new_picture(
      @sprite.Picture::new(
        @math.Vec2D(battle_system.skill_menu.width, battle_system.skill_menu.height),
        "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjIwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjIwIiBoZWlnaHQ9IjIwMCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjMDAwMGZmIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1kYXNoYXJyYXk9IjUsNSIvPjwvc3ZnPg=="
      ),
      100
    )
    @sprite.sprites.set(skill_menu_entity, skill_menu_boundary)
    @position.positions.set(skill_menu_entity, battle_system.skill_menu.position)
    @ui.uis.set(skill_menu_entity, @ui.Ui::new())
    battle_system.debug_entities.push(skill_menu_entity)
  }
  
  println("ğŸ”§ èœå•è°ƒè¯•è¾¹ç•Œæ¡†åˆ›å»ºå®Œæˆ")
} 

///|
// ç®€åŒ–çš„èœå•è®¾ç½® - æ¨¡ä»¿ui.mbtçš„è®¾è®¡æ¨¡å¼
fn setup_battle_menu() -> Unit {
  // åˆ›å»ºFightæŒ‰é’®
  let fight_button = @system.Entity::new()
  @position.positions.set(fight_button, @math.Vec2D(60, 210))
  let fight_sprite = @sprite.Sprite::new_picture(
    @sprite.Picture::new(
      @math.Vec2D(80, 25),
      "pixel_adventure/Menu/Buttons/Play.png",
    ),
    240,
  )
  @sprite.sprites.set(fight_button, fight_sprite)
  @ui.uis.set(fight_button, @ui.Ui::new())
  
  // ä¸ºFightæŒ‰é’®æ·»åŠ ç¢°æ’æ£€æµ‹
  let fight_area = @collision.Area::new(
    @collision.CollisionShape::Rect(
      size=@math.Vec2D(80.0, 25.0),
      offset=@math.Vec2D::zero(),
    ),
    @collision.CollisionLayer::new(),
    @collision.CollisionMask::empty(),
    monitoring_mouse=true,
  )
  fight_area.on_just_released(fn(mouse_button) {
    if mouse_button == @system.MouseButton::Left {
      println("âš”ï¸ FightæŒ‰é’®è¢«ç‚¹å‡»ï¼")
      battle_system.main_menu.selected_option = Fight
      handle_menu_selection()
    }
  })
  @collision.areas.set(fight_button, fight_area)
  battle_system.battle_entities.push(fight_button)
  
  // åˆ›å»ºBagæŒ‰é’®
  let bag_button = @system.Entity::new()
  @position.positions.set(bag_button, @math.Vec2D(60, 240))
  let bag_sprite = @sprite.Sprite::new_picture(
    @sprite.Picture::new(
      @math.Vec2D(80, 25),
      "pixel_adventure/Menu/Buttons/Play.png",
    ),
    240,
  )
  @sprite.sprites.set(bag_button, bag_sprite)
  @ui.uis.set(bag_button, @ui.Ui::new())
  
  let bag_area = @collision.Area::new(
    @collision.CollisionShape::Rect(
      size=@math.Vec2D(80.0, 25.0),
      offset=@math.Vec2D::zero(),
    ),
    @collision.CollisionLayer::new(),
    @collision.CollisionMask::empty(),
    monitoring_mouse=true,
  )
  bag_area.on_just_released(fn(mouse_button) {
    if mouse_button == @system.MouseButton::Left {
      println("ğŸ’ BagæŒ‰é’®è¢«ç‚¹å‡»ï¼")
      battle_system.main_menu.selected_option = Bag
      handle_menu_selection()
    }
  })
  @collision.areas.set(bag_button, bag_area)
  battle_system.battle_entities.push(bag_button)
  
  // åˆ›å»ºPokemonæŒ‰é’®
  let pokemon_button = @system.Entity::new()
  @position.positions.set(pokemon_button, @math.Vec2D(60, 270))
  let pokemon_sprite = @sprite.Sprite::new_picture(
    @sprite.Picture::new(
      @math.Vec2D(80, 25),
      "pixel_adventure/Menu/Buttons/Play.png",
    ),
    240,
  )
  @sprite.sprites.set(pokemon_button, pokemon_sprite)
  @ui.uis.set(pokemon_button, @ui.Ui::new())
  
  let pokemon_area = @collision.Area::new(
    @collision.CollisionShape::Rect(
      size=@math.Vec2D(80.0, 25.0),
      offset=@math.Vec2D::zero(),
    ),
    @collision.CollisionLayer::new(),
    @collision.CollisionMask::empty(),
    monitoring_mouse=true,
  )
  pokemon_area.on_just_released(fn(mouse_button) {
    if mouse_button == @system.MouseButton::Left {
      println("ğŸ± PokemonæŒ‰é’®è¢«ç‚¹å‡»ï¼")
      battle_system.main_menu.selected_option = Pokemon
      handle_menu_selection()
    }
  })
  @collision.areas.set(pokemon_button, pokemon_area)
  battle_system.battle_entities.push(pokemon_button)
  
  // åˆ›å»ºRunæŒ‰é’®
  let run_button = @system.Entity::new()
  @position.positions.set(run_button, @math.Vec2D(60, 300))
  let run_sprite = @sprite.Sprite::new_picture(
    @sprite.Picture::new(
      @math.Vec2D(80, 25),
      "pixel_adventure/Menu/Buttons/Play.png",
    ),
    240,
  )
  @sprite.sprites.set(run_button, run_sprite)
  @ui.uis.set(run_button, @ui.Ui::new())
  
  let run_area = @collision.Area::new(
    @collision.CollisionShape::Rect(
      size=@math.Vec2D(80.0, 25.0),
      offset=@math.Vec2D::zero(),
    ),
    @collision.CollisionLayer::new(),
    @collision.CollisionMask::empty(),
    monitoring_mouse=true,
  )
  run_area.on_just_released(fn(mouse_button) {
    if mouse_button == @system.MouseButton::Left {
      println("ğŸƒ RunæŒ‰é’®è¢«ç‚¹å‡»ï¼")
      battle_system.main_menu.selected_option = Run
      handle_menu_selection()
    }
  })
  @collision.areas.set(run_button, run_area)
  battle_system.battle_entities.push(run_button)
  
  // æ·»åŠ æŒ‰é’®æ–‡æœ¬
  add_button_text(fight_button, "Fight", 60, 210)
  add_button_text(bag_button, "Bag", 60, 240)
  add_button_text(pokemon_button, "Pokemon", 60, 270)
  add_button_text(run_button, "Run", 60, 300)
}

///|
// ä¸ºæŒ‰é’®æ·»åŠ æ–‡æœ¬æ ‡ç­¾
fn add_button_text(button_entity : @system.Entity, text : String, x : Double, y : Double) -> Unit {
  let text_entity = @system.Entity::new()
  let text_sprite = @sprite.Sprite::new_text(
    @sprite.Text::new(text, color="#FFFFFF", font="16px Arial"),
    250
  )
  @sprite.sprites.set(text_entity, text_sprite)
  @position.positions.set(text_entity, @math.Vec2D(x + 40, y + 5)) // æ–‡æœ¬å±…ä¸­
  @ui.uis.set(text_entity, @ui.Ui::new())
  battle_system.battle_entities.push(text_entity)
} 