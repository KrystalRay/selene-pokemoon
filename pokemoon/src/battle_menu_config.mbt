// Copyright 2025 International Digital Economy Academy
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

///|
// æˆ˜æ–—èœå•é…ç½® - é›†ä¸­ç®¡ç†æ‰€æœ‰menuå‚æ•°å’Œå¸ƒå±€
struct BattleMenuConfig {
  // ä¸»æˆ˜æ–—èœå•é…ç½®
  main_menu : MainMenuConfig
  
  // æŠ€èƒ½èœå•é…ç½®
  skill_menu : SkillMenuConfig
  
  // å±å¹•å°ºå¯¸é…ç½®
  screen : ScreenConfig
  
  // å¸ƒå±€é…ç½®
  layout : LayoutConfig
}

///|
// ä¸»æˆ˜æ–—èœå•é…ç½®
struct MainMenuConfig {
  // åŸºç¡€å±žæ€§
  visible : Bool
  selected_index : Int
  selected_option : MenuOption
  
  // å‡ ä½•å±žæ€§ - éœ€è¦åŠ¨æ€è°ƒæ•´
  mut position : @math.Vec2D
  mut width : Double
  mut height : Double
  
  // æ ·å¼é…ç½®
  background_color : String
  border_color : String
  text_color : String
  indicator_color : String
  
  // æŒ‰é’®é…ç½®
  button_spacing : Double
  button_height : Double
  button_padding : Double
}

///|
// æŠ€èƒ½èœå•é…ç½®
struct SkillMenuConfig {
  // åŸºç¡€å±žæ€§
  visible : Bool
  selected_index : Int
  
  // å‡ ä½•å±žæ€§ - éœ€è¦åŠ¨æ€è°ƒæ•´
  mut position : @math.Vec2D
  mut width : Double
  mut height : Double
  
  // æ ·å¼é…ç½®
  background_color : String
  border_color : String
  text_color : String
  indicator_color : String
  title_color : String
  
  // æŠ€èƒ½é¡¹é…ç½®
  skill_spacing : Double
  skill_height : Double
  skill_padding : Double
  title_height : Double
}

///|
// å±å¹•é…ç½®
struct ScreenConfig {
  width : Double
  height : Double
  title_height : Double
  prompt_height : Double
}

///|
// å¸ƒå±€é…ç½®
struct LayoutConfig {
  // è¾¹è·å’Œé—´è·
  margin : Double
  padding : Double
  
  // åŒºåŸŸå°ºå¯¸
  enemy_area_width : Double
  enemy_area_height : Double
  player_area_width : Double
  player_area_height : Double
  menu_area_width : Double
  menu_area_height : Double
  status_area_width : Double
  status_area_height : Double
  
  // ä½ç½®åç§»
  title_offset_y : Double
  enemy_offset_y : Double
  player_offset_y : Double
  menu_offset_y : Double
  status_offset_y : Double
}

///|
// å…¨å±€æˆ˜æ–—èœå•é…ç½®å®žä¾‹
let battle_menu_config : BattleMenuConfig = {
  // ä¸»èœå•é…ç½®
  main_menu: MainMenuConfig::{
    visible: false,
    selected_index: 0,
    selected_option: Fight,
    position: @math.Vec2D(50.0, 400.0),
    width: 170.0,
    height: 115.0,
    background_color: "#1a1a1a",
    border_color: "#4ECDC4",
    text_color: "#FFFFFF",
    indicator_color: "#4ECDC4",
    button_spacing: 25.0,
    button_height: 20.0,
    button_padding: 10.0
  },
  
  // æŠ€èƒ½èœå•é…ç½®
  skill_menu: SkillMenuConfig::{
    visible: false,
    selected_index: 0,
    position: @math.Vec2D(250.0, 400.0),
    width: 220.0,
    height: 200.0,
    background_color: "#1a1a1a",
    border_color: "#4ECDC4",
    text_color: "#FFFFFF",
    indicator_color: "#4ECDC4",
    title_color: "#FFFFFF",
    skill_spacing: 30.0,
    skill_height: 25.0,
    skill_padding: 25.0,
    title_height: 20.0
  },
  
  // å±å¹•é…ç½®
  screen: ScreenConfig::{
    width: 800.0,
    height: 600.0,
    title_height: 32.0,
    prompt_height: 18.0
  },
  
  // å¸ƒå±€é…ç½®
  layout: LayoutConfig::{
    margin: 20.0,
    padding: 15.0,
    enemy_area_width: 120.0,
    enemy_area_height: 100.0,
    player_area_width: 120.0,
    player_area_height: 100.0,
    menu_area_width: 200.0,
    menu_area_height: 120.0,
    status_area_width: 100.0,
    status_area_height: 80.0,
    title_offset_y: 20.0,
    enemy_offset_y: 50.0,
    player_offset_y: 50.0,
    menu_offset_y: 170.0,
    status_offset_y: 170.0
  }
}

///|
// ===== å¸ƒå±€ä½ç½®è®¡ç®—å‡½æ•° =====

///|
// èŽ·å–æ•ŒäººåŒºåŸŸä½ç½®ï¼ˆå·¦ä¸Šè§’ï¼‰
fn get_enemy_area_position() -> @math.Vec2D {
  @math.Vec2D(
    battle_menu_config.layout.margin,
    battle_menu_config.layout.margin + battle_menu_config.layout.enemy_offset_y
  )
}

///|
// èŽ·å–çŽ©å®¶åŒºåŸŸä½ç½®ï¼ˆå³ä¸Šè§’ï¼‰
fn get_player_area_position() -> @math.Vec2D {
  @math.Vec2D(
    battle_menu_config.screen.width - battle_menu_config.layout.margin - battle_menu_config.layout.player_area_width,
    battle_menu_config.layout.margin + battle_menu_config.layout.player_offset_y
  )
}

///|
// èŽ·å–èœå•åŒºåŸŸä½ç½®ï¼ˆå·¦ä¸‹è§’ï¼Œæ•Œäººä¸‹æ–¹ï¼‰
fn get_menu_area_position() -> @math.Vec2D {
  @math.Vec2D(
    battle_menu_config.layout.margin,
    battle_menu_config.layout.margin + battle_menu_config.layout.enemy_offset_y + battle_menu_config.layout.enemy_area_height + 20.0
  )
}

///|
// èŽ·å–çŠ¶æ€åŒºåŸŸä½ç½®ï¼ˆå³ä¸‹è§’ï¼ŒçŽ©å®¶ä¸‹æ–¹ï¼‰
fn get_status_area_position() -> @math.Vec2D {
  @math.Vec2D(
    battle_menu_config.screen.width - battle_menu_config.layout.margin - battle_menu_config.layout.status_area_width,
    battle_menu_config.layout.margin + battle_menu_config.layout.player_offset_y + battle_menu_config.layout.player_area_height + 20.0
  )
}

///|
// èŽ·å–æ ‡é¢˜ä½ç½®ï¼ˆé¡¶éƒ¨ä¸­å¿ƒï¼‰
fn get_title_position() -> @math.Vec2D {
  @math.Vec2D(
    battle_menu_config.screen.width / 2.0,
    battle_menu_config.layout.margin + battle_menu_config.layout.title_offset_y
  )
}

///|
// èŽ·å–æç¤ºæ–‡æœ¬ä½ç½®ï¼ˆæ ‡é¢˜ä¸‹æ–¹ï¼‰
fn get_prompt_position() -> @math.Vec2D {
  let title_pos = get_title_position()
  @math.Vec2D(title_pos.0, title_pos.1 + 40.0)
}

///|
// èŽ·å–èœå•æŒ‰é’®ä½ç½®ï¼ˆåž‚ç›´æŽ’åˆ—ï¼‰
fn get_menu_button_positions() -> Array[@math.Vec2D] {
  let positions = Array::new()
  let start_x = battle_menu_config.layout.margin + battle_menu_config.layout.padding
  let start_y = battle_menu_config.screen.height - battle_menu_config.layout.margin - battle_menu_config.layout.menu_area_height + battle_menu_config.layout.padding
  let button_height = 25.0
  let spacing = button_height + battle_menu_config.layout.padding
  
  // å››ä¸ªæŒ‰é’®ï¼šFight, Bag, Pokemon, Run
  let button_count = 4
  let mut i = 0
  while i < button_count {
    let y = start_y + (i.to_double() * spacing)
    positions.push(@math.Vec2D(start_x, y))
    i = i + 1
  }
  
  positions
}

///|
// èŽ·å–æŠ€èƒ½èœå•ä½ç½®ï¼ˆå±å¹•ä¸­å¿ƒï¼‰
fn get_skill_menu_position() -> @math.Vec2D {
  @math.Vec2D(
    battle_menu_config.screen.width / 2.0 - 100.0,
    battle_menu_config.screen.height / 2.0 - 80.0
  )
}

///|
// èŽ·å–HPæ–‡æœ¬ä½ç½®
fn get_hp_text_position(is_enemy : Bool) -> @math.Vec2D {
  if is_enemy {
    // æ•ŒäººHP - æ•ŒäººåŒºåŸŸä¸‹æ–¹
    let enemy_pos = get_enemy_area_position()
    @math.Vec2D(
      enemy_pos.0 + battle_menu_config.layout.padding,
      enemy_pos.1 + battle_menu_config.layout.enemy_area_height + battle_menu_config.layout.padding
    )
  } else {
    // çŽ©å®¶HP - çŽ©å®¶åŒºåŸŸä¸‹æ–¹
    let player_pos = get_player_area_position()
    @math.Vec2D(
      player_pos.0 + battle_menu_config.layout.padding,
      player_pos.1 + battle_menu_config.layout.player_area_height + battle_menu_config.layout.padding
    )
  }
}

///|
// ===== é…ç½®è®¿é—®å‡½æ•° =====

///|
fn get_main_menu_config() -> MainMenuConfig {
  battle_menu_config.main_menu
}

///|
fn get_skill_menu_config() -> SkillMenuConfig {
  battle_menu_config.skill_menu
}

///|
fn get_screen_config() -> ScreenConfig {
  battle_menu_config.screen
}

///|
fn get_layout_config() -> LayoutConfig {
  battle_menu_config.layout
}

///|
fn get_main_menu_position() -> @math.Vec2D {
  battle_menu_config.main_menu.position
}

///|
fn get_main_menu_size() -> @math.Vec2D {
  @math.Vec2D(battle_menu_config.main_menu.width, battle_menu_config.main_menu.height)
}

///|
fn get_skill_menu_size() -> @math.Vec2D {
  @math.Vec2D(battle_menu_config.skill_menu.width, battle_menu_config.skill_menu.height)
}

///|
// ===== åŠ¨æ€è°ƒæ•´å‡½æ•° =====

///|
// åŠ¨æ€è°ƒæ•´èœå•å°ºå¯¸
fn adjust_menu_sizes() -> Unit {
  let screen_width = battle_menu_config.screen.width
  let screen_height = battle_menu_config.screen.height
  
  // è°ƒæ•´ä¸»èœå•å°ºå¯¸
  battle_menu_config.main_menu.width = screen_width * 0.33
  battle_menu_config.main_menu.height = screen_height * 0.3
  
  // è°ƒæ•´æŠ€èƒ½èœå•å°ºå¯¸
  battle_menu_config.skill_menu.width = screen_width * 0.35
  battle_menu_config.skill_menu.height = screen_height * 0.25
  
  println("ðŸ“ èœå•å°ºå¯¸å·²è°ƒæ•´:")
  println("  ä¸»èœå•: " + battle_menu_config.main_menu.width.to_string() + " x " + battle_menu_config.main_menu.height.to_string())
  println("  æŠ€èƒ½èœå•: " + battle_menu_config.skill_menu.width.to_string() + " x " + battle_menu_config.skill_menu.height.to_string())
}

///|
// é‡æ–°å®šä½èœå•
fn reposition_menus() -> Unit {
  // é‡æ–°å®šä½ä¸»èœå•
  let new_main_menu_x = 50.0
  let new_main_menu_y = 400.0
  battle_menu_config.main_menu.position = @math.Vec2D(new_main_menu_x, new_main_menu_y)
  
  // é‡æ–°å®šä½æŠ€èƒ½èœå•
  let skill_menu_x = new_main_menu_x + battle_menu_config.main_menu.width + 30.0
  let skill_menu_y = new_main_menu_y
  battle_menu_config.skill_menu.position = @math.Vec2D(skill_menu_x, skill_menu_y)
  
  println("ðŸ“ èœå•ä½ç½®å·²é‡æ–°å®šä½:")
  println("  ä¸»èœå•: (" + battle_menu_config.main_menu.position.0.to_string() + ", " + battle_menu_config.main_menu.position.1.to_string() + ")")
  println("  æŠ€èƒ½èœå•: (" + battle_menu_config.skill_menu.position.0.to_string() + ", " + battle_menu_config.skill_menu.position.1.to_string() + ")")
}

///|
// éªŒè¯èœå•è¾¹ç•Œ
fn validate_menu_boundaries() -> Bool {
  let screen_width = battle_menu_config.screen.width
  let screen_height = battle_menu_config.screen.height
  
  // æ£€æŸ¥ä¸»èœå•è¾¹ç•Œ
  let main_menu_right = battle_menu_config.main_menu.position.0 + battle_menu_config.main_menu.width
  let main_menu_bottom = battle_menu_config.main_menu.position.1 + battle_menu_config.main_menu.height
  
  let main_menu_valid = battle_menu_config.main_menu.position.0 >= 0.0 && 
                       battle_menu_config.main_menu.position.1 >= 0.0 &&
                       main_menu_right <= screen_width &&
                       main_menu_bottom <= screen_height
  
  // æ£€æŸ¥æŠ€èƒ½èœå•è¾¹ç•Œ
  let skill_menu_right = battle_menu_config.skill_menu.position.0 + battle_menu_config.skill_menu.width
  let skill_menu_bottom = battle_menu_config.skill_menu.position.1 + battle_menu_config.skill_menu.height
  
  let skill_menu_valid = battle_menu_config.skill_menu.position.0 >= 0.0 && 
                        battle_menu_config.skill_menu.position.1 >= 0.0 &&
                        skill_menu_right <= screen_width &&
                        skill_menu_bottom <= screen_height
  
  println("ðŸ” èœå•è¾¹ç•ŒéªŒè¯:")
  println("  ä¸»èœå•: " + (if main_menu_valid { "âœ… åœ¨å±å¹•å†…" } else { "âŒ è¶…å‡ºå±å¹•" }))
  println("  æŠ€èƒ½èœå•: " + (if skill_menu_valid { "âœ… åœ¨å±å¹•å†…" } else { "âŒ è¶…å‡ºå±å¹•" }))
  
  return main_menu_valid && skill_menu_valid
} 