// Copyright 2025 International Digital Economy Academy
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

///|
// æ¸¸æˆæ ¸å¿ƒç®¡ç†ç³»ç»Ÿ
// è´Ÿè´£ç®¡ç†æ¸¸æˆçŠ¶æ€ã€UIã€èƒŒåŒ…ã€æˆ˜æ–—ç­‰æ ¸å¿ƒåŠŸèƒ½

///|
// æ¸¸æˆçŠ¶æ€æšä¸¾
pub enum GameState {
  MainMenu
  World
  Battle
  Backpack
  Settings
} derive(Show, Eq)

///|
// èƒŒåŒ…é¡¹ç›®ç±»å‹
pub enum ItemType {
  Ball
  Heal
  Cure
  Revive
  PP
  Stat
} derive(Show, Eq)

///|
// èƒŒåŒ…é¡¹ç›®
pub struct BackpackItem {
  id : Int
  name : String
  icon : String
  count : Int
  item_type : ItemType
} derive(Show)

///|
// å®å¯æ¢¦çŠ¶æ€
pub enum PokemonStatus {
  Normal
  Poison
  Burn
  Freeze
  Paralysis
  Sleep
} derive(Show, Eq)

///|
// å®å¯æ¢¦æŠ€èƒ½
pub struct PokemonMove {
  name : String
  power : Int
  move_type : String
} derive(Show)

///|
// å®å¯æ¢¦
pub struct Pokemon {
  id : Int
  name : String
  english_name : String
  level : Int
  hp : Int
  max_hp : Int
  attack : Int
  defense : Int
  speed : Int
  types : Array[String]
  status : PokemonStatus
  moves : Array[PokemonMove]
  exp : Int
  next_level_exp : Int
} derive(Show)

///|
// ç©å®¶çŠ¶æ€
pub struct PlayerStatus {
  level : Int
  exp : Int
  next_level_exp : Int
  badges : Int
  max_badges : Int
  money : Int
  caught_count : Int
  battle_count : Int
  win_count : Int
  play_time : String
} derive(Show)

///|
// èƒŒåŒ…æ•°æ®
pub struct BackpackData {
  pokemon : Array[Pokemon]
  items : Array[BackpackItem]
  selected_pokemon : Option[Int]
  selected_item : Option[Int]
} derive(Show)

///|
// æ¸¸æˆç®¡ç†å™¨
pub struct GameManager {
  current_state : GameState
  backpack_data : BackpackData
  player_status : PlayerStatus
  battle_mode : Bool
} derive(Show)

///|
// åˆ›å»ºé»˜è®¤èƒŒåŒ…æ•°æ®
pub fn create_default_backpack() -> BackpackData {
  let default_pokemon = [
    Pokemon::{
      id: 1,
      name: "å°ç«é¾™",
      english_name: "Charmander",
      level: 25,
      hp: 85,
      max_hp: 100,
      attack: 65,
      defense: 45,
      speed: 60,
      types: ["Fire"],
      status: PokemonStatus::Normal,
      moves: [
        PokemonMove::{ name: "ç«ç„°å–·å°„", power: 110, move_type: "Fire" },
        PokemonMove::{ name: "æŠ“", power: 40, move_type: "Normal" },
        PokemonMove::{ name: "çƒŸå¹•", power: 0, move_type: "Normal" },
        PokemonMove::{ name: "ç«èŠ±", power: 40, move_type: "Fire" }
      ],
      exp: 1250,
      next_level_exp: 2000
    },
    Pokemon::{
      id: 2,
      name: "çš®å¡ä¸˜",
      english_name: "Pikachu",
      level: 23,
      hp: 78,
      max_hp: 90,
      attack: 55,
      defense: 40,
      speed: 90,
      types: ["Electric"],
      status: PokemonStatus::Normal,
      moves: [
        PokemonMove::{ name: "åä¸‡ä¼ç‰¹", power: 90, move_type: "Electric" },
        PokemonMove::{ name: "ç”µå…‰ä¸€é—ª", power: 40, move_type: "Normal" },
        PokemonMove::{ name: "æ‘‡å°¾å·´", power: 0, move_type: "Normal" },
        PokemonMove::{ name: "å«å£°", power: 0, move_type: "Normal" }
      ],
      exp: 980,
      next_level_exp: 1500
    },
    Pokemon::{
      id: 3,
      name: "å¦™è›™ç§å­",
      english_name: "Bulbasaur",
      level: 22,
      hp: 82,
      max_hp: 95,
      attack: 50,
      defense: 55,
      speed: 45,
      types: ["Grass", "Poison"],
      status: PokemonStatus::Normal,
      moves: [
        PokemonMove::{ name: "è—¤é­", power: 45, move_type: "Grass" },
        PokemonMove::{ name: "é£å¶å¿«åˆ€", power: 55, move_type: "Grass" },
        PokemonMove::{ name: "å…‰åˆä½œç”¨", power: 0, move_type: "Grass" },
        PokemonMove::{ name: "å¯„ç”Ÿç§å­", power: 0, move_type: "Grass" }
      ],
      exp: 890,
      next_level_exp: 1400
    }
  ]
  
  let default_items = [
    BackpackItem::{ id: 1, name: "ç²¾çµçƒ", icon: "ğŸ”´", count: 15, item_type: ItemType::Ball },
    BackpackItem::{ id: 2, name: "è¶…çº§çƒ", icon: "ğŸ”µ", count: 8, item_type: ItemType::Ball },
    BackpackItem::{ id: 3, name: "ä¼¤è¯", icon: "ğŸ’Š", count: 12, item_type: ItemType::Heal },
    BackpackItem::{ id: 4, name: "è§£æ¯’è¯", icon: "ğŸ§ª", count: 5, item_type: ItemType::Cure },
    BackpackItem::{ id: 5, name: "çƒ§ä¼¤è¯", icon: "ğŸ”¥", count: 3, item_type: ItemType::Cure },
    BackpackItem::{ id: 6, name: "éº»ç—¹è¯", icon: "âš¡", count: 4, item_type: ItemType::Cure },
    BackpackItem::{ id: 7, name: "å¤æ´»è¯", icon: "ğŸ’€", count: 2, item_type: ItemType::Revive },
    BackpackItem::{ id: 8, name: "PPæ¢å¤", icon: "ğŸ’", count: 6, item_type: ItemType::PP },
    BackpackItem::{ id: 9, name: "åŠ›é‡ç²‰", icon: "ğŸ’ª", count: 3, item_type: ItemType::Stat },
    BackpackItem::{ id: 10, name: "é€Ÿåº¦ç²‰", icon: "ğŸƒ", count: 2, item_type: ItemType::Stat },
    BackpackItem::{ id: 11, name: "é˜²å¾¡ç²‰", icon: "ğŸ›¡ï¸", count: 2, item_type: ItemType::Stat },
    BackpackItem::{ id: 12, name: "ç‰¹é˜²ç²‰", icon: "âœ¨", count: 1, item_type: ItemType::Stat }
  ]
  
  BackpackData::{
    pokemon: default_pokemon,
    items: default_items,
    selected_pokemon: None,
    selected_item: None
  }
}

///|
// åˆ›å»ºé»˜è®¤ç©å®¶çŠ¶æ€
pub fn create_default_player_status() -> PlayerStatus {
  PlayerStatus::{
    level: 5,
    exp: 1250,
    next_level_exp: 2000,
    badges: 2,
    max_badges: 8,
    money: 5280,
    caught_count: 12,
    battle_count: 28,
    win_count: 24,
    play_time: "2:15:30"
  }
}

///|
// åˆ›å»ºæ¸¸æˆç®¡ç†å™¨
pub fn create_game_core_manager() -> GameManager {
  GameManager::{
    current_state: GameState::World,
    backpack_data: create_default_backpack(),
    player_status: create_default_player_status(),
    battle_mode: false
  }
}

///|
// åˆ‡æ¢æ¸¸æˆçŠ¶æ€
pub fn change_game_state(manager : GameManager, new_state : GameState) -> GameManager {
  GameManager::{
    current_state: new_state,
    backpack_data: manager.backpack_data,
    player_status: manager.player_status,
    battle_mode: manager.battle_mode
  }
}

///|
// è¿›å…¥æˆ˜æ–—æ¨¡å¼
pub fn enter_battle_mode(manager : GameManager) -> GameManager {
  GameManager::{
    current_state: GameState::Battle,
    backpack_data: manager.backpack_data,
    player_status: manager.player_status,
    battle_mode: true
  }
}

///|
// é€€å‡ºæˆ˜æ–—æ¨¡å¼
pub fn exit_battle_mode(manager : GameManager) -> GameManager {
  GameManager::{
    current_state: GameState::World,
    backpack_data: manager.backpack_data,
    player_status: manager.player_status,
    battle_mode: false
  }
}

///|
// é€‰æ‹©å®å¯æ¢¦
pub fn select_pokemon(manager : GameManager, pokemon_id : Int) -> GameManager {
  let updated_backpack = BackpackData::{
    pokemon: manager.backpack_data.pokemon,
    items: manager.backpack_data.items,
    selected_pokemon: Some(pokemon_id),
    selected_item: manager.backpack_data.selected_item
  }
  
  GameManager::{
    current_state: manager.current_state,
    backpack_data: updated_backpack,
    player_status: manager.player_status,
    battle_mode: manager.battle_mode
  }
}

///|
// é€‰æ‹©é“å…·
pub fn select_item(manager : GameManager, item_id : Int) -> GameManager {
  let updated_backpack = BackpackData::{
    pokemon: manager.backpack_data.pokemon,
    items: manager.backpack_data.items,
    selected_pokemon: manager.backpack_data.selected_pokemon,
    selected_item: Some(item_id)
  }
  
  GameManager::{
    current_state: manager.current_state,
    backpack_data: updated_backpack,
    player_status: manager.player_status,
    battle_mode: manager.battle_mode
  }
}

///|
// æ²»ç–—é€‰ä¸­çš„å®å¯æ¢¦
pub fn heal_selected_pokemon(manager : GameManager) -> GameManager {
  // ç®€åŒ–çš„æ²»ç–—é€»è¾‘ï¼Œæš‚æ—¶è¿”å›åŸç®¡ç†å™¨
  manager
}

///|
// ä½¿ç”¨é€‰ä¸­çš„é“å…·
pub fn use_selected_item(manager : GameManager) -> GameManager {
  // ç®€åŒ–çš„é“å…·ä½¿ç”¨é€»è¾‘ï¼Œæš‚æ—¶è¿”å›åŸç®¡ç†å™¨
  manager
}

///|
// è·å–å®å¯æ¢¦æ•°é‡
pub fn get_pokemon_count(backpack : BackpackData) -> Int {
  backpack.pokemon.length()
}

///|
// è·å–é“å…·æ•°é‡
pub fn get_item_count(backpack : BackpackData) -> Int {
  backpack.items.length()
}

///|
// è·å–é€‰ä¸­çš„å®å¯æ¢¦
pub fn get_selected_pokemon(backpack : BackpackData) -> Option[Pokemon] {
  match backpack.selected_pokemon {
    Some(pokemon_id) => {
      // ç®€åŒ–çš„æŸ¥æ‰¾é€»è¾‘ï¼Œå®é™…åº”è¯¥éå†æ•°ç»„
      // è¿™é‡Œæš‚æ—¶è¿”å›Noneï¼Œé¿å…å¤æ‚çš„æ•°ç»„æ“ä½œ
      None
    }
    None => None
  }
}

///|
// è·å–é€‰ä¸­çš„é“å…·
pub fn get_selected_item(backpack : BackpackData) -> Option[BackpackItem] {
  match backpack.selected_item {
    Some(item_id) => {
      // ç®€åŒ–çš„æŸ¥æ‰¾é€»è¾‘ï¼Œå®é™…åº”è¯¥éå†æ•°ç»„
      // è¿™é‡Œæš‚æ—¶è¿”å›Noneï¼Œé¿å…å¤æ‚çš„æ•°ç»„æ“ä½œ
      None
    }
    None => None
  }
}

///|
// æ£€æŸ¥å®å¯æ¢¦æ˜¯å¦éœ€è¦æ²»ç–—
pub fn needs_healing(pokemon : Pokemon) -> Bool {
  pokemon.hp < pokemon.max_hp || pokemon.status != PokemonStatus::Normal
}

///|
// è·å–çŠ¶æ€æ–‡æœ¬
pub fn get_status_text(status : PokemonStatus) -> String {
  match status {
    PokemonStatus::Normal => "æ­£å¸¸"
    PokemonStatus::Poison => "ä¸­æ¯’"
    PokemonStatus::Burn => "ç¼çƒ§"
    PokemonStatus::Freeze => "å†°å†»"
    PokemonStatus::Paralysis => "éº»ç—¹"
    PokemonStatus::Sleep => "ç¡çœ "
  }
}

///|
// è·å–ç±»å‹æ ·å¼ç±»å
pub fn get_type_class_name(type_name : String) -> String {
  // ç®€åŒ–çš„ç±»å‹åç§°å¤„ç†ï¼Œé¿å…ä½¿ç”¨ä¸æ”¯æŒçš„to_lowercaseæ–¹æ³•
  "type-" + type_name
}

///|
// è®¡ç®—HPç™¾åˆ†æ¯”
pub fn calculate_hp_percentage(pokemon : Pokemon) -> Double {
  (pokemon.hp.to_double() / pokemon.max_hp.to_double()) * 100.0
}

///|
// æµ‹è¯•æ¸¸æˆæ ¸å¿ƒç³»ç»Ÿ
pub fn test_game_core_system() -> Unit {
  println("=== æµ‹è¯•æ¸¸æˆæ ¸å¿ƒç³»ç»Ÿ ===")
  
  // åˆ›å»ºæ¸¸æˆç®¡ç†å™¨
  let manager = create_game_core_manager()
  println("âœ“ æ¸¸æˆç®¡ç†å™¨åˆ›å»ºæˆåŠŸ")
  
  // æµ‹è¯•çŠ¶æ€åˆ‡æ¢
  let battle_manager = enter_battle_mode(manager)
  println("âœ“ è¿›å…¥æˆ˜æ–—æ¨¡å¼æˆåŠŸ")
  
  let world_manager = exit_battle_mode(battle_manager)
  println("âœ“ é€€å‡ºæˆ˜æ–—æ¨¡å¼æˆåŠŸ")
  
  // æµ‹è¯•å®å¯æ¢¦é€‰æ‹©
  let selected_manager = select_pokemon(world_manager, 1)
  println("âœ“ é€‰æ‹©å®å¯æ¢¦æˆåŠŸ")
  
  // æµ‹è¯•é“å…·é€‰æ‹©
  let item_manager = select_item(selected_manager, 1)
  println("âœ“ é€‰æ‹©é“å…·æˆåŠŸ")
  
  // æµ‹è¯•æ²»ç–—åŠŸèƒ½
  let healed_manager = heal_selected_pokemon(item_manager)
  println("âœ“ æ²»ç–—å®å¯æ¢¦æˆåŠŸ")
  
  // æµ‹è¯•é“å…·ä½¿ç”¨
  let used_manager = use_selected_item(healed_manager)
  println("âœ“ ä½¿ç”¨é“å…·æˆåŠŸ")
  
  // æµ‹è¯•æ•°æ®è·å–
  let pokemon_count = get_pokemon_count(used_manager.backpack_data)
  let item_count = get_item_count(used_manager.backpack_data)
  println("âœ“ å®å¯æ¢¦æ•°é‡: " + pokemon_count.to_string())
  println("âœ“ é“å…·æ•°é‡: " + item_count.to_string())
  
  println("=== æ¸¸æˆæ ¸å¿ƒç³»ç»Ÿæµ‹è¯•å®Œæˆ ===")
} 