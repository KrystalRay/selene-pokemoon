// Copyright 2025 International Digital Economy Academy
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

///|
// UIæ§åˆ¶å™¨ - å®ç°æ¸¸æˆç”»é¢ä¸HTML UIçš„äº¤äº’
// ä¿æŒé«˜å†…èšã€ä½è€¦åˆçš„æ¨¡å—åŒ–è®¾è®¡

///|
// æ¸¸æˆçŠ¶æ€æšä¸¾
pub enum GameState {
  Initializing
  Ready
  Battle
  Menu
  Paused
  GameOver
} derive(Show, Eq)

///|
// äº¤äº’äº‹ä»¶ç±»å‹
pub enum InteractionEvent {
  ButtonClick(String)
  KeyPress(String)
  MouseClick(Int, Int)
  StateChange(GameState)
  BattleAction(String)
} derive(Show)

///|
// UIå…ƒç´ çŠ¶æ€
pub struct UIElement {
  id: String
  visible: Bool
  enabled: Bool
  text: String
  position_x: Int
  position_y: Int
} derive(Show)

///|
// æ¸¸æˆäº¤äº’ç®¡ç†å™¨
pub struct GameInteractionManager {
  current_state: GameState
  ui_elements: Array[UIElement]
  event_handlers: Array[String]
} derive(Show)

///|
// åˆ›å»ºæ–°çš„äº¤äº’ç®¡ç†å™¨
pub fn create_interaction_manager() -> GameInteractionManager {
  GameInteractionManager::{
    current_state: GameState::Initializing,
    ui_elements: [],
    event_handlers: []
  }
}

///|
// æ›´æ–°æ¸¸æˆçŠ¶æ€
pub fn update_game_state(
  manager: GameInteractionManager,
  new_state: GameState
) -> GameInteractionManager {
  GameInteractionManager::{
    current_state: new_state,
    ui_elements: manager.ui_elements,
    event_handlers: manager.event_handlers
  }
}

///|
// æ·»åŠ UIå…ƒç´ 
pub fn add_ui_element(
  manager: GameInteractionManager,
  element: UIElement
) -> GameInteractionManager {
  let new_elements = manager.ui_elements + [element]
  GameInteractionManager::{
    current_state: manager.current_state,
    ui_elements: new_elements,
    event_handlers: manager.event_handlers
  }
}

///|
// å¤„ç†æŒ‰é’®ç‚¹å‡»äº‹ä»¶
pub fn handle_button_click(
  button_id: String,
  current_state: GameState
) -> String {
  match (button_id, current_state) {
    ("damage-test", _) => "è§¦å‘ä¼¤å®³è®¡ç®—æµ‹è¯•"
    ("move-test", _) => "è§¦å‘æŠ€èƒ½æ•ˆæœæµ‹è¯•"
    ("status-test", _) => "è§¦å‘çŠ¶æ€æ•ˆæœæµ‹è¯•"
    ("stat-test", _) => "è§¦å‘å±æ€§ä¿®æ”¹æµ‹è¯•"
    ("string-test", _) => "è§¦å‘å­—ç¬¦ä¸²è½¬æ¢æµ‹è¯•"
    ("all-test", _) => "è§¦å‘å…¨é¢æµ‹è¯•"
    ("start-battle", GameState::Ready) => "å¼€å§‹æˆ˜æ–—"
    ("pause-game", GameState::Battle) => "æš‚åœæ¸¸æˆ"
    ("resume-game", GameState::Paused) => "æ¢å¤æ¸¸æˆ"
    ("main-menu", _) => "è¿”å›ä¸»èœå•"
    _ => "æœªçŸ¥æŒ‰é’®æ“ä½œ"
  }
}

///|
// å¤„ç†é”®ç›˜äº‹ä»¶
pub fn handle_key_press(key: String, current_state: GameState) -> String {
  match (key, current_state) {
    ("Space", GameState::Battle) => "æš‚åœ/æ¢å¤æˆ˜æ–—"
    ("Escape", _) => "è¿”å›ä¸Šçº§èœå•"
    ("Enter", GameState::Ready) => "å¼€å§‹æ¸¸æˆ"
    ("ArrowUp", GameState::Battle) => "å‘ä¸Šç§»åŠ¨"
    ("ArrowDown", GameState::Battle) => "å‘ä¸‹ç§»åŠ¨"
    ("ArrowLeft", GameState::Battle) => "å‘å·¦ç§»åŠ¨"
    ("ArrowRight", GameState::Battle) => "å‘å³ç§»åŠ¨"
    _ => "æŒ‰é”®æœªç»‘å®š"
  }
}

///|
// å¤„ç†é¼ æ ‡ç‚¹å‡»äº‹ä»¶
pub fn handle_mouse_click(x: Int, y: Int, current_state: GameState) -> String {
  // ç®€åŒ–çš„é¼ æ ‡ç‚¹å‡»å¤„ç†ï¼Œå®é™…åº”è¯¥æ£€æŸ¥UIå…ƒç´ è¾¹ç•Œ
  if x >= 100 && x <= 300 && y >= 100 && y <= 150 {
    "ç‚¹å‡»äº†æ ‡é¢˜åŒºåŸŸ"
  } else if x >= 50 && x <= 200 && y >= 200 && y <= 250 {
    "ç‚¹å‡»äº†æŒ‰é’®åŒºåŸŸ"
  } else {
    "ç‚¹å‡»äº†ç©ºç™½åŒºåŸŸ"
  }
}

///|
// è·å–å½“å‰çŠ¶æ€æè¿°
pub fn get_state_description(state: GameState) -> String {
  match state {
    Initializing => "æ¸¸æˆåˆå§‹åŒ–ä¸­..."
    Ready => "æ¸¸æˆå°±ç»ªï¼Œå¯ä»¥å¼€å§‹"
    Battle => "æˆ˜æ–—è¿›è¡Œä¸­"
    Menu => "èœå•ç•Œé¢"
    Paused => "æ¸¸æˆæš‚åœ"
    GameOver => "æ¸¸æˆç»“æŸ"
  }
}

///|
// æ£€æŸ¥çŠ¶æ€è½¬æ¢æ˜¯å¦æœ‰æ•ˆ
pub fn is_valid_state_transition(
  current: GameState,
  target: GameState
) -> Bool {
  match (current, target) {
    (Initializing, Ready) => true
    (Ready, Battle) => true
    (Ready, Menu) => true
    (Battle, Paused) => true
    (Battle, GameOver) => true
    (Paused, Battle) => true
    (Paused, Menu) => true
    (Menu, Ready) => true
    (GameOver, Ready) => true
    _ => false
  }
}

///|
// åˆ›å»ºé»˜è®¤UIå…ƒç´ é…ç½®
pub fn create_default_ui_config() -> Array[UIElement] {
  [
    UIElement::{
      id: "damage-test",
      visible: true,
      enabled: true,
      text: "æµ‹è¯•ä¼¤å®³è®¡ç®—",
      position_x: 10,
      position_y: 10
    }
  ]
}

///|
// æµ‹è¯•UIæ§åˆ¶å™¨åŠŸèƒ½
pub fn test_ui_controller() -> Unit {
  println("ğŸ§ª æµ‹è¯•UIæ§åˆ¶å™¨åŠŸèƒ½...");
  
  // åˆ›å»ºäº¤äº’ç®¡ç†å™¨
  let manager = create_interaction_manager();
  println("âœ… äº¤äº’ç®¡ç†å™¨åˆ›å»ºæˆåŠŸ");
  
  // æµ‹è¯•çŠ¶æ€æ›´æ–°
  let updated_manager = update_game_state(manager, GameState::Ready);
  println("âœ… æ¸¸æˆçŠ¶æ€æ›´æ–°ä¸º: " + get_state_description(updated_manager.current_state));
  
  // æµ‹è¯•æŒ‰é’®ç‚¹å‡»å¤„ç†
  let button_result = handle_button_click("damage-test", updated_manager.current_state);
  println("âœ… æŒ‰é’®ç‚¹å‡»å¤„ç†: " + button_result);
  
  // æµ‹è¯•é”®ç›˜äº‹ä»¶å¤„ç†
  let key_result = handle_key_press("Enter", updated_manager.current_state);
  println("âœ… é”®ç›˜äº‹ä»¶å¤„ç†: " + key_result);
  
  // æµ‹è¯•é¼ æ ‡ç‚¹å‡»å¤„ç†
  let mouse_result = handle_mouse_click(150, 125, updated_manager.current_state);
  println("âœ… é¼ æ ‡ç‚¹å‡»å¤„ç†: " + mouse_result);
  
  // æµ‹è¯•çŠ¶æ€è½¬æ¢éªŒè¯
  let valid_transition = is_valid_state_transition(GameState::Ready, GameState::Battle);
  println("âœ… çŠ¶æ€è½¬æ¢éªŒè¯: Ready -> Battle = " + valid_transition.to_string());
  
  println("ğŸ‰ UIæ§åˆ¶å™¨æµ‹è¯•å®Œæˆï¼");
} 