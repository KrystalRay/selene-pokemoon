// Copyright 2025 International Digital Economy Academy
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

///|
// äº‹ä»¶æ€»çº¿ - å®ç°æ¨¡å—é—´é€šä¿¡ï¼Œä¿æŒé«˜å†…èšä½è€¦åˆ
// åŸºäºå‘å¸ƒ-è®¢é˜…æ¨¡å¼è®¾è®¡

///|
// äº‹ä»¶ç±»å‹
pub enum EventType {
  UIInteraction
  GameStateChange
  BattleAction
  SystemMessage
  DebugInfo
} derive(Show, Eq)

///|
// äº‹ä»¶æ•°æ®
pub struct Event {
  event_type: EventType
  event_name: String
  data: String
  timestamp: String
  source: String
} derive(Show)

///|
// äº‹ä»¶å¤„ç†å™¨
pub struct EventHandler {
  id: String
  event_type: EventType
  handler_name: String
  callback: String
} derive(Show)

///|
// äº‹ä»¶æ€»çº¿ç®¡ç†å™¨
pub struct EventBus {
  handlers: Array[EventHandler]
  event_queue: Array[Event]
  max_queue_size: Int
} derive(Show)

///|
// åˆ›å»ºæ–°çš„äº‹ä»¶æ€»çº¿
pub fn create_event_bus() -> EventBus {
  EventBus::{
    handlers: [],
    event_queue: [],
    max_queue_size: 100
  }
}

///|
// æ³¨å†Œäº‹ä»¶å¤„ç†å™¨
pub fn register_handler(
  bus: EventBus,
  handler: EventHandler
) -> EventBus {
  let new_handlers = bus.handlers + [handler]
  EventBus::{
    handlers: new_handlers,
    event_queue: bus.event_queue,
    max_queue_size: bus.max_queue_size
  }
}

///|
// å‘å¸ƒäº‹ä»¶
pub fn publish_event(
  bus: EventBus,
  event: Event
) -> EventBus {
  // ç®€åŒ–çš„é˜Ÿåˆ—ç®¡ç†ï¼Œæ€»æ˜¯æ·»åŠ æ–°äº‹ä»¶
  let updated_queue = bus.event_queue + [event]
  
  EventBus::{
    handlers: bus.handlers,
    event_queue: updated_queue,
    max_queue_size: bus.max_queue_size
  }
}

///|
// åˆ›å»ºäº‹ä»¶
pub fn create_event(
  event_type: EventType,
  event_name: String,
  data: String,
  source: String
) -> Event {
  Event::{
    event_type: event_type,
    event_name: event_name,
    data: data,
    timestamp: "now", // å®é™…åº”è¯¥ä½¿ç”¨æ—¶é—´å‡½æ•°
    source: source
  }
}

///|
// è·å–äº‹ä»¶ç±»å‹å­—ç¬¦ä¸²
pub fn event_type_to_string(event_type: EventType) -> String {
  match event_type {
    UIInteraction => "UIäº¤äº’"
    GameStateChange => "æ¸¸æˆçŠ¶æ€å˜åŒ–"
    BattleAction => "æˆ˜æ–—åŠ¨ä½œ"
    SystemMessage => "ç³»ç»Ÿæ¶ˆæ¯"
    DebugInfo => "è°ƒè¯•ä¿¡æ¯"
  }
}

///|
// æŸ¥æ‰¾äº‹ä»¶å¤„ç†å™¨
pub fn find_handlers(
  bus: EventBus,
  event_type: EventType
) -> Array[EventHandler] {
  let filtered = bus.handlers.filter(fn(handler: EventHandler) -> Bool {
    handler.event_type == event_type
  })
  filtered
}

///|
// è·å–é˜Ÿåˆ—ä¸­çš„äº‹ä»¶æ•°é‡
pub fn get_queue_size(bus: EventBus) -> Int {
  bus.event_queue.length()
}

///|
// æ¸…ç©ºäº‹ä»¶é˜Ÿåˆ—
pub fn clear_event_queue(bus: EventBus) -> EventBus {
  EventBus::{
    handlers: bus.handlers,
    event_queue: [],
    max_queue_size: bus.max_queue_size
  }
}

///|
// æµ‹è¯•äº‹ä»¶æ€»çº¿åŠŸèƒ½
pub fn test_event_bus() -> Unit {
  println("ğŸ§ª æµ‹è¯•äº‹ä»¶æ€»çº¿åŠŸèƒ½...");
  
  // åˆ›å»ºäº‹ä»¶æ€»çº¿
  let bus = create_event_bus();
  println("âœ… äº‹ä»¶æ€»çº¿åˆ›å»ºæˆåŠŸ");
  
  // åˆ›å»ºäº‹ä»¶å¤„ç†å™¨
  let handler = EventHandler::{
    id: "test-handler-1",
    event_type: EventType::UIInteraction,
    handler_name: "æµ‹è¯•å¤„ç†å™¨",
    callback: "handle_ui_interaction"
  };
  
  // æ³¨å†Œå¤„ç†å™¨
  let bus_with_handler = register_handler(bus, handler);
  println("âœ… äº‹ä»¶å¤„ç†å™¨æ³¨å†ŒæˆåŠŸ");
  
  // åˆ›å»ºå¹¶å‘å¸ƒäº‹ä»¶
  let event = create_event(
    EventType::UIInteraction,
    "æŒ‰é’®ç‚¹å‡»",
    "ç”¨æˆ·ç‚¹å‡»äº†æµ‹è¯•æŒ‰é’®",
    "UIç³»ç»Ÿ"
  );
  
  let bus_with_event = publish_event(bus_with_handler, event);
  println("âœ… äº‹ä»¶å‘å¸ƒæˆåŠŸ");
  
  // æŸ¥æ‰¾å¤„ç†å™¨
  let found_handlers = find_handlers(bus_with_event, EventType::UIInteraction);
  println("âœ… æ‰¾åˆ° " + found_handlers.length().to_string() + " ä¸ªå¤„ç†å™¨");
  
  // è·å–é˜Ÿåˆ—ä¿¡æ¯
  let queue_size = get_queue_size(bus_with_event);
  println("âœ… äº‹ä»¶é˜Ÿåˆ—å¤§å°: " + queue_size.to_string());
  
  // æ¸…ç©ºé˜Ÿåˆ—
  let cleared_bus = clear_event_queue(bus_with_event);
  let new_queue_size = get_queue_size(cleared_bus);
  println("âœ… é˜Ÿåˆ—æ¸…ç©ºåå¤§å°: " + new_queue_size.to_string());
  
  println("ğŸ‰ äº‹ä»¶æ€»çº¿æµ‹è¯•å®Œæˆï¼");
} 